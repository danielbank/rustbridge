(function(t,h,l){t.execute(function(){if(!h.GBDealNotifier){var w=function(f){h.GBDealNotifier={};Object.keys||(Object.keys=function(){var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c="toString toLocaleString valueOf hasOwnProperty isPrototypeOf propertyIsEnumerable constructor".split(" "),d=c.length;return function(e){if("object"!==typeof e&&("function"!==typeof e||null===e))throw new TypeError("Object.keys called on non-object");var g=[],k;for(k in e)a.call(e,
k)&&g.push(k);if(b)for(k=0;k<d;k++)a.call(e,c[k])&&g.push(c[k]);return g}}());GBDealNotifier.popoverTrigger=function(a,b,c){if("object"===typeof amznJQ)amznJQ.available("popover",function(){f(a)[b](c)});else f(a)[b](c)};GBDealNotifier.availableStr="Available";GBDealNotifier.inCartStr="InCart";GBDealNotifier.claimedStr="Claimed";GBDealNotifier.expiredStr="Expired";GBDealNotifier.waitInLineStr="WaitInLine";GBDealNotifier.pendingAtcStr="PendingAddToCart";GBDealNotifier.GD_BATCH_SIZE=100;GBDealNotifier.customerStates=
{NONE:GBDealNotifier.availableStr,INCART:GBDealNotifier.inCartStr,CLAIMED:GBDealNotifier.claimedStr,INWAITLIST:GBDealNotifier.waitInLineStr,PENDINGATC:GBDealNotifier.pendingAtcStr,EXPIRED:GBDealNotifier.expiredStr};GBDealNotifier.responseCustomerStates={NONE:"NONE",INCART:"INCART",CLAIMED:"CLAIMED",INWAITLIST:"INWAITLIST",PENDINGATC:"PENDINGATC",EXPIRED:"EXPIRED"};GBDealNotifier.dealStates={AVAILABLE:"AVAILABLE",EXPIRED:"EXPIRED",SOLDOUT:"SOLDOUT",WAITLIST:"WAITLIST",WAITLISTFULL:"WAITLISTFULL"};
GBDealNotifier.DealAccessTypes={PRIME_EARLY_ACCESS:"PRIME_EARLY_ACCESS",PRIME_ONLY_LD:"PRIME_ONLY_LD",PRIME_ONLY_DOTD:"PRIME_ONLY_DOTD"};GBDealNotifier.log=function(a){h.gbResources!==l&&null!==h.gbResources&&h.gbResources.getDealDebug()&&(a=new Date+": "+a,h.console?h.console.log(a):f("#DealsLog").append(f("div").append(a)))};GBDealNotifier.min=function(a){return Math.min.apply(Math,arguments)};GBDealNotifier.max=function(a){return Math.max.apply(Math,arguments)};GBDealNotifier.sortByAsinTimes=function(a,
b){return a.status.purchaseStatus.expiresDate-b.status.purchaseStatus.expiresDate};GBDealNotifier.filterAsinsByState=function(a,b){for(var c=[],d=0;d<a.length;d++)for(var e=a[d],g=0;g<b.length;g++)if(e.status.purchaseStatus.state==b[g]){c.push(e);break}return c};GBDealNotifier.commify=function(a,b){a=parseFloat(a);a=b!==l?a.toFixed(b):a.toString();for(var c=a.split("."),d=c[0],e=d.length-3;0<e;e-=3)d=d.substr(0,e)+","+d.substr(e,d.length-e);return 2==c.length?d+"."+c[1]:d};GBDealNotifier.stateAlertsEnum=
{ATC_EXPIRES_SOON:0,ATC_EXPIRED:1,WL_PATC:2,WL_PATC_EXPIRED:3,WL_SOLD_OUT:4,WL_DEAL_ENDED:5};GBDealNotifier.watchStateAlertEnum={WATCH_DEAL:6};GBDealNotifier.watchDealStates={WD_LIVE:"LIVE",WD_CANCELLED:"CANCELLED"};GBDealNotifier.pStateTypeEnum={CART:0,WAITLIST:1,EITHER:2,NO_ACTION:3,WATCH_DEAL:4};GBDealNotifier.pStateTypeMap={};GBDealNotifier.pStateTypeMap[GBDealNotifier.availableStr]=GBDealNotifier.pStateTypeEnum.NO_ACTION;GBDealNotifier.pStateTypeMap[GBDealNotifier.inCartStr]=GBDealNotifier.pStateTypeEnum.CART;
GBDealNotifier.pStateTypeMap[GBDealNotifier.claimedStr]=GBDealNotifier.pStateTypeEnum.NO_ACTION;GBDealNotifier.pStateTypeMap[GBDealNotifier.expiredStr]=GBDealNotifier.pStateTypeEnum.EITHER;GBDealNotifier.pStateTypeMap[GBDealNotifier.waitInLineStr]=GBDealNotifier.pStateTypeEnum.WAITLIST;GBDealNotifier.pStateTypeMap[GBDealNotifier.pendingAtcStr]=GBDealNotifier.pStateTypeEnum.WAITLIST;GBDealNotifier.findDealAsin=function(a,b){var c=null;if(null==b.asins)return c;for(var d=0;d<b.asins.length&&(c=b.asins[d],
c.asin!=a);d++);return c};GBDealNotifier.getPurchaseState=function(a,b){var c="Available",c=b;if(null==c&&null!=a&&null!=a.asins){if(1<a.asins.length){for(var c="Available",d={},e=0;e<a.asins.length;e++){var g=GBDealNotifier.getPurchaseState(a,a.asins[e]);d[g]=d[g]?d[g]+1:1}for(g in d)if(a.asins.length==d[g]){c=g;break}return c}null!=a.asins[0]&&(c=a.asins[0])}return c=c&&c.status&&c.status.purchaseStatus?c.status.purchaseStatus.state:c&&c.isCustomerClaimed?"Claimed":"Available"};GBDealNotifier.isClaimed=
function(a,b){return GBDealNotifier.getPurchaseState(a,b)==GBDealNotifier.claimedStr};GBDealNotifier.inState=function(a,b,c){return GBDealNotifier.getPurchaseState(a,b)==c};GBDealNotifier.isSoldOut=function(a){if(!a.asins||0===a.asins.length)return!1;for(var b=0;b<a.asins.length;b++)if(!a.asins[b].offerServiceSoldOut&&100>a.asins[b].status.percentSoldOut)return!1;return!0};GBDealNotifier.formatDealTime=function(a){var b=gbResources.getFeature("gbZoneInfo").offset,b=new Date(a.valueOf()+6E4*a.getTimezoneOffset()+
b);a=b.getHours();b=b.getMinutes();return GBDealNotifier.formatTime(a,b)};GBDealNotifier.formatTime=function(a,b){10>b&&(b="0"+b);var c=gbResources.getCustomerData("realm"),d=gbResources.getFeature("gbZoneInfo"),e="";d&&(e=d.name);d=12<=a?gbResources.getString("csld-pm"):gbResources.getString("csld-am");"US"==c||"UK"==c||"JP"==c?a=a%12||12:10>a&&("DE"==c||"FR"==c)&&(a="0"+a);return gbResources.getString("csld-start_time",{hours:a,minutes:b,period:d,timezone:e})};GBDealNotifier.formatPricePercentage=
function(a){var b=null;return b=null==a?null:"CN"==gbResources.getCustomerData("realm")?a.toFixed(2):Math.round(a)};GBDealNotifier.getWaitlistHelp=function(a){var b="";a!=l&&(b=GBDealNotifier.DOM.img({style:"vertical-align:middle;display: inline;",src:a}));a=GBDealNotifier.DOM.div({"class":"waitlist_help"},[GBDealNotifier.DOM.a({alt:h.gbResources.getString("gbd_what_is_waitlist"),href:"#","class":"waitlist_link"},[h.gbResources.getString("gbd_what_is_waitlist")+" "]),b]);b=GBDealNotifier.DOM.span({"class":"help_message"},
[h.gbResources.getString("csld-waitlist_help")]);GBDealNotifier.popoverTrigger(a,"amazonPopoverTrigger",{showOnHover:!0,width:250,showCloseButton:!1,location:"over",literalContent:b});return a};GBDealNotifier.isPrimeEligible=function(a){if(a.asins)for(var b=0;b<a.asins.length;b++)if(a.asins[b].isPrimeEligible)return!0;return!1};GBDealNotifier.resizeImage=function(a,b){a&&(a=a.replace(/\.((_.*_)\.)?(gif|jpg)$/,".$2_AA"+b+"_.$3"));return a||""};GBDealNotifier.checkAndSetSSLImageUrl=function(a){if(null==
a)return a;"https:"==h.location.protocol&&(a=a.replace(/(http:\/\/[^\/]*\/)(.*$)/,"https://images-na.ssl-images-amazon.com/$2"));return a};GBDealNotifier.Class=function(a,b){if(b===l)for(var c in b)a[c]=b[c];c=a&&a.__init__||function(){};c.prototype=a;return c};GBDealNotifier.dealUrl=function(a){if(a.detail.url)return GBDealNotifier.appendUrlParameter(a.detail.url,"smid",a.merchantID);if(1==a.asins.length)return GBDealNotifier.appendUrlParameter("/gp/product/"+a.asins[0].asin,"smid",a.merchantID);
if(1<a.asins.length&&a.parentAsin)return GBDealNotifier.appendUrlParameter("/gp/product/"+a.parentAsin,"smid",a.merchantID);GBDealNotifier.log("fudging title href");return"/gp/goldbox"};GBDealNotifier.appendUrlParameter=function(a,b,c){var d="?";-1!=a.indexOf("?")&&(d="&");return a+d+b+"="+c};GBDealNotifier.Utilities={checkAndSetSSLImageUrl:function(a){if(null===a)return a;if("https:"===h.location.protocol){var b="images-na.ssl-images-amazon.com";"CN"===gbResources.getCustomerData("realm")&&(b="images-cn.ssl-images-amazon.com");
var c=document.createElement("a");c.href=a;c.protocol="https:";c.hostname=b;a=c.href}return a},setDealDetailURL:function(a,b){return"/gp/product/"+(b?a.teaserAsin:a.reviewAsin)+"/ref=xs_gb_ld_tck_"+a.dealID},setUrlParam:function(a,b,c){var d=a.indexOf("#"),e=-1===d?"":a.substr(d);a=-1===d?a:a.substr(0,d);var d=new RegExp("([?&])"+b+"=.*?(&|$)","i"),g=-1!==a.indexOf("?")?"&":"?";a=a.match(d)?a.replace(d,"$1"+b+"="+c+"$2"):a+g+b+"="+c;return a+e},getDisplayablePercentOff:function(a){return a&&"number"===
typeof a?"CN"===gbResources.getCustomerData("realm")?(100-a)/10:a:null},getFormattedPrice:function(a,b){var c=GBDealNotifier.Price.currencies[b],d=document.createElement("span");c&&(d.innerHTML=c.format(GBDealNotifier.Utilities.commifyNumber(a,c.decimals)));return d.innerHTML},commifyNumber:function(a,b){a=parseFloat(a);a=b!==l||null!==b?a.toFixed(b):a.toString();for(var c=a.split("."),d=c[0],e=d.length-3;0<e;e-=3)d=d.substr(0,e)+","+d.substr(e,d.length-e);return 2===c.length?d+"."+c[1]:d},_loadPrimeDataFromServiceResponse:function(a,
b){a.detail.isPrimeEarlyAccessDeal=!1;a.detail.isPrimeOnly=!1;"PRIME_EARLY_ACCESS"===b.primeAccessType&&gbResources.getFeature("prime_early_access")?(a.detail.primeAccessType=b.primeAccessType,a.detail.primeAccessDurationInMs=6E4*parseInt(b.primeAccessDuration,10),a.detail.isPrimeEarlyAccessDeal=!0):"PRIME_ONLY_LD"===b.primeAccessType?(a.detail.primeAccessType=b.primeAccessType,a.detail.isPrimeOnly=!0):"PRIME_ONLY_DOTD"===b.primeAccessType?(a.detail.primeAccessType="PRIME_ONLY_DOTD",a.detail.isPrimeOnly=
!0):"PRIME_ONLY_BD"===b.primeAccessType&&(a.detail.primeAccessType="PRIME_ONLY_BD",a.detail.isPrimeOnly=!0);return a},_loadReviewsFromServiceResponse:function(a,b){b.reviewAsin&&(a.reviews.URL="/gp/product-reviews/"+b.reviewAsin);null!==b.totalReviews&&b.totalReviews!==l&&(a.reviews.total=parseInt(b.totalReviews,10));null!==b.reviewRating&&b.reviewRating!==l&&(a.reviews.rating=parseFloat(b.reviewRating));return a},_loadPricingDataFromServiceResponse:function(a,b){var c=null;if("VARIATION_ITEM"===
b.itemType)for(var d in b.items){var e=b.items[d];if(e.itemID===b.reviewAsin){c=e;break}}c?a.pricingData.prices.dealPrice={max:{value:parseFloat(c.dealPrice)},min:{value:parseFloat(c.dealPrice)}}:null!==b.maxDealPrice&&b.maxDealPrice!==l&&null!==b.minDealPrice&&b.minDealPrice!==l&&(a.pricingData.prices.dealPrice={max:{value:parseFloat(b.maxDealPrice)},min:{value:parseFloat(b.minDealPrice)}});c?a.pricingData.prices.basisPrice={max:{value:parseFloat(c.bAmount)},min:{value:parseFloat(c.bAmount)}}:null!==
b.maxBAmount&&b.maxBAmount!==l&&null!==b.minBAmount&&b.minBAmount!==l&&(a.pricingData.prices.basisPrice={max:{value:parseFloat(b.maxBAmount)},min:{value:parseFloat(b.minBAmount)}});c?a.pricingData.percentOff=GBDealNotifier.Utilities.getDisplayablePercentOff(c.percentOff):b.maxPercentOff&&b.minPercentOff&&(maxPercentOff=parseInt(b.maxPercentOff),minPercentOff=parseInt(b.minPercentOff),maxPercentOff===minPercentOff&&(a.pricingData.percentOff=GBDealNotifier.Utilities.getDisplayablePercentOff(maxPercentOff)));
null!==b.pricePerUnit&&b.pricePerUnit!==l&&(a.pricingData.unitPrice={value:parseFloat(b.pricePerUnit)},a.pricingData.unitPrice.formattedValue=GBDealNotifier.Utilities.getFormattedPrice(a.pricingData.unitPrice.value,a.currencyCode));null!==b.baseUnitValue&&b.baseUnitValue!==l&&null!==b.baseUnitName&&b.baseUnitName!==l&&(a.pricingData.baseUnit={value:b.baseUnitValue,name:b.baseUnitName});var c=a.pricingData.prices,g;for(g in c)if(null!==c[g]||c[g]!==l){d=c[g];for(var k in d)d[k].formattedValue=GBDealNotifier.Utilities.getFormattedPrice(d[k].value,
a.currencyCode)}b.bKind&&(a.pricingData.bKind=b.bKind);return a}};GBDealNotifier.Signal={methods:["connect","disconnectAll","signal"],init:function(a){var b,c;if(a.__signals__)throw Error("already registered");if(a.signals===l)throw Error("expected 'signals' attribute");for(b=0;b<this.methods.length;b++)if(c=this.methods[b],a[c]!==l)throw Error("method "+c+" is already defined");a.__signals__={};for(b=0;b<a.signals.length;b++)a.__signals__[a.signals[b]]={};for(b=0;b<this.methods.length;b++)c=this.methods[b],
a[c]=this[c]},next_id:100,connect:function(a,b,c){var d=this;if(d.__signals__[a]===l)throw Error("no such signal "+a);var e=GBDealNotifier.Signal.next_id++,g={signals:["disconnect"],disconnect:function(){delete d.__signals__[a][e];this.signal("disconnect");this.disconnect=function(){}}};if(b instanceof Function)g.trigger=b;else{if(b[c]===l)throw Error("method '"+c+"' for obj "+b+" doesn't exist");if(!b[c]instanceof Function)throw Error("method '"+c+"' for obj "+b+" isn't a Function");g.trigger=function(){b[c].apply(b,
arguments)}}d.__signals__[a][e]=g;GBDealNotifier.Signal.init(g);return g},disconnectAll:function(a){var b;if(a){if(this.__signals__[a]===l)throw Error("no such signal "+a);for(var c in this.__signals__[a])this.__signals__[a][c].disconnect()}else for(b in this.__signals__)this.disconnectAll(b)},signal:function(a){if(this.__signals__[a]===l)throw Error("no such signal "+a);var b=[],c=1;1==arguments.length&&(c=0);for(c;c<arguments.length;c++)b.push(arguments[c]);var c=[],d;for(d in this.__signals__[a]){var e=
this.__signals__[a][d];try{e.trigger.apply(e,b)}catch(g){c.push(g)}}if(1<c.length)throw b=Error("multiple errors. See 'errors'"),b.errors=c,b;if(1==c.length)throw c[0];}};GBDealNotifier.Service=GBDealNotifier.Class({__init__:function(a){if(!a.marketplace_id)throw Error("must specify 'marketplace_id'");this.marketplace_id=a.marketplace_id;this.customer_id=a.customer_id;this.session_id=a.session_id;this.timeout=a.timeout||3E5;this.includeVariations=a.includeVariations},ajax_with_retries:function(a){var b=
this,c=new Date,d=0,e=a.retryInterval||GBDealNotifier.Service.base_retry_interval||6E4;delete a.retryInterval;var g=a.error;delete a.error;var k=function(){GBDealNotifier.Service.continue_requests?(-1==a.url.indexOf("?")?a.url=a.url+"?nocache="+(new Date).getTime():a.url=a.url+"&nocache="+(new Date).getTime(),a.error=function(a){var p=e*(1+Math.pow(2,d++)*Math.random());p+(new Date).getTime()-c.getTime()>b.timeout?g(Error("Retries timed out"+JSON.stringify(a))):(GBDealNotifier.log("retrying after "+
p+"ms"),h.setTimeout(k,p))},f.ajax(a)):g(Error("continue_requests is false: no more requests should be made."))};k()},call:function(a,b,c,d,e){a={success:function(a){a.responseMetadata&&(GBDealNotifier.Service.base_retry_interval=a.responseMetadata.baseRetryInterval,GBDealNotifier.Service.continue_requests=a.responseMetadata.continueRetries);c(a)},error:d,url:a,type:"POST",data:JSON.stringify(b),dataType:"json"};e!==l&&(a.retryInterval=e);this.ajax_with_retries(a)},get_deal_metadata:function(a,b,
c){this.call("/xa/goldbox/GetDealMetadata",{requestMetadata:{marketplaceID:this.marketplace_id},filters:a.filters,orderings:a.orderings,includeVariations:this.includeVariations},b,c)},_deal_ids_from_callbacks:function(a){var b=[],c;for(c in a)b.push(c);return b},get_deals:function(a,b){var c=this._deal_ids_from_callbacks(a),d;null==b&&(b=GBDealNotifier.Service.DealIDDealFilter(c));this.call("/xa/goldbox/GetDeals",{requestMetadata:{marketplaceID:this.marketplace_id},customerID:this.customer_id,filter:b,
ordering:[],page:1,resultsPerPage:c.length,includeVariations:this.includeVariations},function(b){var g={};for(d=0;d<b.deals.length;d++){var k=b.deals[d];a[k.dealID][0](k);g[k.dealID]=!0}for(d=0;d<c.length;d++)if(b=c[d],!g[b])a[b][1](Error("No deal returned for dealID "+b))},function(b){for(d=0;d<c.length;d++)a[c[d]][1](b)})},get_deal_statuses:function(a){var b=this._deal_ids_from_callbacks(a);this.call("/xa/goldbox/GetDealStatus",{requestMetadata:{marketplaceID:this.marketplace_id},dealIDs:b},function(c){var d=
{},e,g;for(e in c.dealStatus)g=c.dealStatus[e],a[g.dealID][0](g),d[g.dealID]=!0;for(c=0;c<b.length;c++)if(e=b[c],!d[e])a[e][1](Error("No status returned for dealID "+e))},function(c){var d,e;for(d=0;d<b.length;d++)e=b[d],a[e][1](c)})},get_deal_asin_statuses:function(a){var b=this._deal_ids_from_callbacks(a);GBDealNotifier.log("Calling GetDealAsinStatus: "+b);this.call("/xa/goldbox/GetDealAsinStatus",{requestMetadata:{marketplaceID:this.marketplace_id},customerID:this.customer_id,filter:GBDealNotifier.Service.DealIDDealFilter(b)},
function(b){b=b.dealAsinStatuses;for(var d={},e={},g=0;g<b.length;g++){var k=b[g];d[k.asin]=k;e[k.dealID]=1}for(var m in e)a[m][0](d)},function(c){for(var d=0;d<b.length;d++)a[b[d]][1](c)})},get_deal_asin_status:function(a,b,c){this.call("/xa/goldbox/GetDealAsinStatus",{requestMetadata:{marketplaceID:this.marketplace_id},customerID:this.customer_id,dealID:a},b,c)},get_deal_asin_status2:function(a,b,c){return this._add_request("get_deal_asin_status",a,b,c)},redeem_deal:function(a,b,c,d){this.call("/gp/deal/ajax/redeemDeal.html?marketplaceID="+
gbResources.getCustomerData("marketplaceId")+"&dealID="+a+"&asin="+b+"&sessionID="+this.session_id,{},c,d,GBDealNotifier.Service.base_retry_interval/4)},claim_deal:function(a,b,c,d){this.call("/gp/deal/ajax/claimDeal.html?dealId="+a+"&itemId="+b,{},c,d,GBDealNotifier.Service.base_retry_interval/4)},_pending:{get_deal:{current:!1,timeout:l,deal_ids:{}},get_deal_status:{current:!1,timeout:l,deal_ids:{}},get_deal_asin_status:{current:!1,timeout:l,deal_ids:{}}},next_id:100,get_deal:function(a,b,c){return this._add_request("get_deal",
a,b,c)},get_deal_status:function(a,b,c){return this._add_request("get_deal_status",a,b,c)},_add_request:function(a,b,c,d){var e=this._pending[a];e.deal_ids[b]===l&&(e.deal_ids[b]={});var g=e.deal_ids[b],k=this.next_id++;b={cancel:function(){delete g[k];this.cancel=function(){throw Error("already cancelled");}},success:c,error:d};g[k]=b;this._start_request_timer(a);return b},_start_request_timer:function(a){var b=this,c=b._pending[a];c.current||(c.timeout&&h.clearTimeout(c.timeout),c.timeout=h.setTimeout(function(){c.timeout=
l;b._start_request(a)},100))},_start_request:function(a){var b=this,c=b._pending[a];c.timeout&&(h.clearTimeout(c.timeout),c.timeout=l);if(!c.current){var d=[],e={},g;for(g in c.deal_ids){if(10<=d.length)break;var k=!1,m;for(m in c.deal_ids[g]){k=!0;break}if(!k){delete c.deal_ids[g];break}c.deal_ids[g].current||(c.deal_ids[g].current=!0,d.push(g),function(g){e[g]=[function(k){b._request_success(a,g,k)},function(k){b._request_error(a,g,k)}]}(g))}0!==d.length&&("get_deal"==a?b.get_deals(e):"get_deal_status"==
a?b.get_deal_statuses(e):"get_deal_asin_status"==a&&b.get_deal_asin_statuses(e))}},_request_success:function(a,b,c){var d=this._pending[a];d.current=!1;var e=d.deal_ids[b];if(e!==l){delete d.deal_ids[b];delete e.current;for(var g in e)e[g].success(c)}this._start_request_timer(a)},_request_error:function(a,b,c){var d=this._pending[a];d.current=!1;var e=d.deal_ids[b];if(e!==l){delete d.deal_ids[b];delete e.current;for(var g in e)e[g].error(c)}this._start_request_timer(a)}});GBDealNotifier.Service.base_url=
"http://internal.amazon.com/coral/com.amazon.DealService.model/";GBDealNotifier.Service.AndDealFilter=function(a){return{__type:"AndDealFilter:"+GBDealNotifier.Service.base_url,children:a}};GBDealNotifier.Service.OrDealFilter=function(a){return{__type:"OrDealFilter:"+GBDealNotifier.Service.base_url,children:a}};GBDealNotifier.Service.DealIDDealFilter=function(a){return{__type:"DealIDDealFilter:"+GBDealNotifier.Service.base_url,dealIDs:a}};GBDealNotifier.Service.SlotDealFilter=function(a){return{__type:"SlotDealFilter:"+
GBDealNotifier.Service.base_url,slots:a}};GBDealNotifier.Service.AsinDealFilter=function(a){return{__type:"AsinDealFilter:"+GBDealNotifier.Service.base_url,asins:a}};GBDealNotifier.Service.AvailableDealFilter=function(){return{__type:"AvailableDealFilter:"+GBDealNotifier.Service.base_url}};GBDealNotifier.Service.StartDateDealFilter=function(a,b){return{__type:"StartDateDealFilter:"+GBDealNotifier.Service.base_url,from:a instanceof Date?a.valueOf():a,to:b instanceof Date?b.valueOf():b}};GBDealNotifier.Service.EndDateDealFilter=
function(a,b){return{__type:"EndDateDealFilter:"+GBDealNotifier.Service.base_url,from:a instanceof Date?a.valueOf():a,to:b instanceof Date?b.valueOf():b}};GBDealNotifier.Service.SoldOutDealFilter=function(a){return{__type:"SoldOutDealFilter:"+GBDealNotifier.Service.base_url,soldOut:a}};GBDealNotifier.Service.ClaimedDealFilter=function(a){return{__type:"ClaimedDealFilter:"+GBDealNotifier.Service.base_url,claimed:a}};GBDealNotifier.Service.StartDateDealOrder=function(){return{__type:"StartDateDealOrder:"+
GBDealNotifier.Service.base_url}};GBDealNotifier.Service.NextAvailableDealOrder=function(){return{__type:"NextAvailableDealOrder:"+GBDealNotifier.Service.base_url}};GBDealNotifier.Service.BucketDealOrder=function(a){return{__type:"BucketDealOrder:"+GBDealNotifier.Service.base_url,slots:a}};GBDealNotifier.Model={};GBDealNotifier.Model.Metadata=GBDealNotifier.Class({__init__:function(a,b){this.filters=a;for(var c in this.filters){var d=this.filters[c];this.filters[c]={};for(var e=0;e<d.length;e++)this.filters[c][d[e]]=
!0}this.orderings=b},get_deal_ids:function(a,b){a=this.filters[a];b=b?this.orderings[b]:[];var c=[],d={},e,g;for(e=0;e<b.length;e++)g=b[e],d[g]=!0,a[g]&&c.push(g);for(g in a)d[g]||c.push(g);return c}});GBDealNotifier.Model.Deals=GBDealNotifier.Class({__init__:function(a){this.deals={};for(var b=0;b<a.length;b++){var c=a[b];this.get_deal(c.dealID).load_from_deal(c)}},get_deal:function(a){this.deals[a]===l&&(this.deals[a]=new GBDealNotifier.Model.Deal(a));return this.deals[a]}});GBDealNotifier.Model.Deal=
GBDealNotifier.Class({signals:["change","expire","status_expire","pstatus_expires_soon","pstatus_expire"],__init__:function(a){GBDealNotifier.Signal.init(this);this.dealID=a;this.timeouts={};this.expired=this.loading=!0;this.status={expired:!0};this.detail={};this.asins=[];this.reviews={URL:null,total:null,rating:null};this.pricingData={dealPrice:null,basisPrice:null,percentOff:null};this.merchantName=null;this.asinExpiresSoonStack=[];this.asinExpiredStack=[];this.purchaseStatusWarningThreshold=6E5},
_init_status:function(a){var b=this;b.status.cacheExpiresDate=new Date(a.getTime()+parseInt(b.status.msToCacheExpires,10));b.status.expired=!1;b.status.startDate=new Date(a.getTime()+parseInt(b.status.msToStart,10));b.status.started=0>=b.status.msToStart;b.status.endDate=new Date(a.getTime()+parseInt(b.status.msToEnd,10));b.status.ended=0>=b.status.msToEnd;b.timeouts.start_timeout&&h.clearTimeout(b.timeouts.start_timeout);b.status.started||(b.timeouts.start_timeout=h.setTimeout(function(){b.status.started=
!0;b.signal("change",b)},b.status.startDate.getTime()-(new Date).getTime()));b.timeouts.end_timeout&&h.clearTimeout(b.timeouts.end_timeout);b.status.ended||(b.timeouts.end_timeout=h.setTimeout(function(){b.status.ended=!0;b.signal("change",b)},b.status.endDate.getTime()-(new Date).getTime()));b.timeouts.status_expire_timeout&&h.clearTimeout(b.timeouts.status_expire_timeout);b.timeouts.status_expire_timeout=h.setTimeout(function(){b.status.expired=!0;b.signal("status_expire",b)},b.status.cacheExpiresDate.getTime()-
(new Date).getTime())},_init_asin_statuses:function(){var a=this;if(a.asins){for(var b=new Date,c=GBDealNotifier.filterAsinsByState(a.asins,[GBDealNotifier.inCartStr,GBDealNotifier.expiredStr,GBDealNotifier.waitInLineStr,GBDealNotifier.pendingAtcStr]),d=0;d<c.length;d++){var e=c[d];a.purchaseStatusWarningThreshold&&(e.status.purchaseStatus.expiresDate=new Date(b.getTime()+parseInt(e.status.purchaseStatus.msToExpiry,10)))}c.sort(GBDealNotifier.sortByAsinTimes);a.asinExpiresSoonStack=[];a.asinExpiredStack=
[];for(d=0;d<c.length;d++){e=c[d];a.timeouts.pstatus_exp_soon[e.asin]&&h.clearTimeout(a.timeouts.pstatus_exp_soon[e.asin]);var b=e.status.purchaseStatus.expiresDate.getTime()-(new Date).getTime(),g=b-a.purchaseStatusWarningThreshold;0>g&&(g=0);var k=""+e.asin;0<b&&e.status.purchaseStatus.state!=GBDealNotifier.waitInLineStr&&e.status.purchaseStatus.state!=GBDealNotifier.pendingAtcStr&&(a.asinExpiresSoonStack.push(k),a.timeouts.pstatus_exp_soon[k]=h.setTimeout(function(){var g=a.asinExpiresSoonStack.shift();
a.signal("pstatus_expires_soon",a,g)},g));a.timeouts.pstatus_expire[e.asin]&&h.clearTimeout(a.timeouts.pstatus_expire[e.asin]);a.asinExpiredStack.push(k);a.timeouts.pstatus_expire[e.asin]=h.setTimeout(function(){var g=a.asinExpiredStack.shift();a.signal("pstatus_expire",a,g);a.signal("change",a)},b)}}else GBDealNotifier.log("No Asins, not initializing statuses.")},load_from_deal:function(a){var b=this,c=new Date,d;for(d in a)b[d]=a[d];b.loading=!1;b.startDate=new Date(1E3*b.startDate);b.endDate=new Date(1E3*
b.endDate);b.cacheExpiresDate=new Date(c.getTime()+parseInt(b.msToCacheExpires,10));b.expired=!1;b.timeouts.expire_timeout&&h.clearTimeout(b.timeouts.expire_timeout);b.timeouts.expire_timeout=h.setTimeout(function(){b.expired=!0;b.signal("expire",b)},b.cacheExpiresDate.getTime()-(new Date).getTime());b.limitedQuantity="1"==b.limitedQuantity;b.customer&&(b.customer.claimed="1"==b.customer.claimed);if(b.asins)for(b.timeouts.pstatus_exp_soon||(b.timeouts.pstatus_exp_soon={}),b.timeouts.pstatus_expire||
(b.timeouts.pstatus_expire={}),a=0;a<b.asins.length;a++)b.asins[a].offerServiceSoldOut="1"==b.asins[a].offerServiceSoldOut;b._init_status(c);b._init_asin_statuses();b.signal("change",b)},load_from_status:function(a){this.status=a;this._init_status(new Date);this.signal("change",this)},load_from_asin_status:function(a){if(null!=this.asins&&null!=a){for(var b=a.asin,c=0;c<this.asins.length;c++)if(this.asins[c].asin==b){this.asins[c].status=a;break}this._init_asin_statuses();this.signal("change",this)}},
setPurchaseStatusWarningThreshold:function(a){self.purchaseStatusWarningThreshold=0<a?a:12E4},getPurchaseStatusWarningThreshold:function(){return this.purchaseStatusWarningThreshold},_loadFromDealDAO:function(a){this.loading=!1;var b=gbResources.customerData.marketplaceId;this.marketplaceID=b;this.merchantName=a.merchantName;this.merchantID=a.merchantID;this.dealID=a.dealID;this.legacyDealID=a.legacyDealID;this.startDate=a.status.dates.start;this.endDate=a.status.dates.end;this.msToCacheExpires=a.status.timeouts.cacheExpires;
this.cacheExpiresDate=a.status.dates.cacheExpires;this.status={marketplaceID:b,dealID:a.dealID,percentClaimed:a.status.percentClaimed,msToStart:a.status.timeouts.start,startDate:a.status.dates.start,started:0>=a.status.timeouts.start,msToEnd:a.status.timeouts.end,endDate:a.status.dates.end,ended:0>=a.status.timeouts.end,msToCacheExpires:a.status.timeouts.cacheExpires,cacheExpiresDate:a.status.dates.cacheExpires,expired:!1};this.detail={marketplaceID:b,dealID:a.dealID,title:a.detail.title,description:a.detail.description,
imageAsin:a.detail.imageAsin,url:a.detail.URL,buyBoxUrl:a.detail.buyAsin};this.asins=[];var c=a.items,d=l;c.constructor===Array?d=c.length:c.constructor===Object&&(d=Object.keys(c).length);if(d&&0!==d)for(var e in c){var g=c[e],k=g.status.itemState,d=GBDealNotifier.customerStates[g.status.customerState],d={marketplaceID:b,dealID:a.dealID,asin:g.asinID,basisPrice:g.basisPriceFormatted,basisKind:g.bKind,dealPrice:g.dealPriceFormatted,percentOff:g.percentOff,offerServiceSoldOut:"SOLDOUT"===k?!0:!1,variationData:g.variationDimensions,
imageURL:g.imageURL,isCustomerClaimed:d===GBDealNotifier.claimedStr?!0:!1,status:{marketplaceID:b,dealID:a.dealID,asin:g.asinID,percentClaimed:g.status.percentClaimed,percentSoldOut:"SOLDOUT"===k?100:a.status.percentSoldOut,itemState:k,currentlyUnavailable:"WAITLISTFULL"===k?!0:!1,purchaseStatus:{state:d,msToExpiry:g.status.dates.incartEnds-new Date}}};this.asins.push(d)}else c=a.dealState,d=GBDealNotifier.customerStates[a.customerState],d={marketplaceID:b,dealID:a.dealID,asin:a.detail.buyAsin,basisPrice:a.pricingData.prices.basisPrice?
a.pricingData.prices.basisPrice.min.formattedValue:"",dealPrice:a.pricingData.prices.dealPrice?a.pricingData.prices.dealPrice.min.formattedValue:"",basisKind:a.pricingData.bKind,percentOff:a.pricingData.percentOff,offerServiceSoldOut:"SOLDOUT"===c?!0:!1,variationData:a.variationDimensions,imageURL:a.detail.imageAsin,isCustomerClaimed:d===GBDealNotifier.claimedStr?!0:!1,status:{marketplaceID:b,dealID:a.dealID,asin:a.detail.buyAsin,percentClaimed:"SOLDOUT"===c?100:a.status.percentSoldOut,percentSoldOut:a.status.percentSoldOut,
itemState:c,currentlyUnavailable:"WAITLISTFULL"===c?!0:!1,purchaseStatus:{state:d,msToExpiry:a.status.dates.incartEnds-new Date}}},this.asins.push(d);this.customer={marketplaceID:b,dealID:a.dealID,customerID:gbResources.customerData.customerId,claimed:!1};this.pricingData=a.pricingData;this.reviews=a.reviews},_loadStatusFromDealDAO:function(a){var b=this,c=new Date;b._loadFromDealDAO(a);b.timeouts.expire_timeout&&h.clearTimeout(b.timeouts.expire_timeout);b.cacheExpiresDate&&(b.timeouts.expire_timeout=
h.setTimeout(function(){b.expired=!0;b.signal("expire",b)},b.cacheExpiresDate.getTime()-(new Date).getTime()));b.asins&&(b.timeouts.pstatus_exp_soon||(b.timeouts.pstatus_exp_soon={}),b.timeouts.pstatus_expire||(b.timeouts.pstatus_expire={}));b._init_status(c);b._init_asin_statuses();b.signal("change",b)}});GBDealNotifier.Model.WatchDeal=GBDealNotifier.Class({__init__:function(a){this.dealID=a;this.customerState=this.currencyCode=this.legacyDealID=this.merchantName=null;this.status={dealID:null,dealState:null,
startDate:null,endDate:null,msToStart:null,msToEnd:null,percentClaimed:null,isValidDeal:1};this.detail={title:null,imageAsin:null,URL:null,itemType:null,buyAsin:null,primeAccessType:null,marketingMessage:null,isPrimeOnly:null,isPrimeEarlyAccessDeal:null,isFulfilledByAmazon:null,egressUrl:null};this.customerData={marketplaceID:null,dealID:null,customerID:null};this.reviews={URL:null,total:null,rating:null};this.pricingData={prices:{dealPrice:null,basisPrice:null},percentOff:null,bKind:null,unitPrice:null,
baseUnit:null}},_loadFromDealDAO:function(a){this.dealID=a.dealID;this.merchantName=a.merchantName;this.legacyDealID=a.legacyDealID;this.status.dealID=a.dealID;this.status.dealState=a.status.dealState;this.status.startDate=a.status.startDate;this.status.endDate=a.status.endDate;this.status.msToStart=a.status.msToStart;this.status.msToEnd=a.status.msToEnd;this.status.percentClaimed=a.status.percentClaimed;this.status.isValidDeal=a.status.isValidDeal;var b=a.detail;this.detail.dealID=a.dealID;this.detail.title=
b.title;this.detail.description=b.description;this.detail.imageAsin=b.imageAsin;this.detail.URL=b.URL;this.detail.buyBoxUrl=b.buyBoxURL;this.detail.itemType=b.itemType;this.detail.buyAsin=b.buyAsin;this.detail.primeAccessType=b.primeAccessType;this.detail.marketingMessage=b.marketingMessage;this.detail.isPrimeOnly=b.isPrimeOnly;this.detail.isPrimeEarlyAccessDeal=b.isPrimeEarlyAccessDeal;this.detail.isFulfilledByAmazon=b.isFulfilledByAmazon;this.customerData.marketplaceID=a.detail.marketplaceID;this.customerData.dealID=
a.dealID;this.customerData.customerID=a.customerID;b=a.reviews;this.reviews.URL=b.URL;this.reviews.total=b.total;this.reviews.rating=b.rating;a=a.pricingData;this.pricingData.prices.dealPrice=a.prices.dealPrice;this.pricingData.prices.basisPrice=a.prices.basisPrice;this.pricingData.percentOff=a.percentOff;this.pricingData.bKind=a.bKind;this.pricingData.unitPrice=a.unitPrice;this.pricingData.baseUnit=a.baseUnit},_loadDetailsFromServiceResponse:function(a){this.merchantName=a.merchantName;this.legacyDealID=
a.legacyDealID;this.detail.dealID=a.dealID;this.detail.title=a.title;this.detail.egressUrl=a.egressUrl;this.detail.description=a.description;this.currencyCode=a.currencyCode;a.primaryImage&&(this.detail.imageAsin=GBDealNotifier.Utilities.checkAndSetSSLImageUrl(a.primaryImage));this.detail.URL=GBDealNotifier.Utilities.setDealDetailURL(a,!1);this.detail.itemType=a.itemType;this.detail.buyAsin=a.reviewAsin;this.detail.marketingMessage=a.marketingMessage;this.detail.isFulfilledByAmazon=a.isFulfilledByAmazon;
GBDealNotifier.Utilities._loadPrimeDataFromServiceResponse(this,a);GBDealNotifier.Utilities._loadReviewsFromServiceResponse(this,a);GBDealNotifier.Utilities._loadPricingDataFromServiceResponse(this,a)},_loadStatusFromServiceResponse:function(a){this.status.dealID=a.dealID;this.status.dealState=a.dealState;this.status.msToStart=a.msToStart;this.status.msToEnd=a.msToEnd;this.status.isValidDeal=a.isValid;a.percentClaimed!==l&&null!==a.percentClaimed&&(this.status.percentClaimed=parseInt(a.percentClaimed,
10))},_updateTeaserDetails:function(a){if("UPCOMING"===this.status.dealState||"COMINGSOON"===this.status.dealState)a.teaser&&a.teaserImage&&(this.detail.imageAsin=GBDealNotifier.Utilities.checkAndSetSSLImageUrl(a.teaserImage)),this.detail.URL=GBDealNotifier.Utilities.setDealDetailURL(a,!0)||""}});GBDealNotifier.Price={currencies:{USD:{decimals:2,format:function(a){return"$"+a}},GBP:{decimals:2,format:function(a){return"&pound;"+a}},EUR:{decimals:2,format:function(a){return("EUR "+a).replace(".",",")}},
JPY:{decimals:0,format:function(a){return"&yen; "+a}},CNY:{decimals:2,format:function(a){return"&yen; "+a}},CAD:{decimals:2,format:function(a){return("C$"+a).replace(",","")}},INR:{decimals:2,format:function(a){return"&#8377;"+a}},BRL:{decimals:2,format:function(a){return"R$ "+a}},MXN:{decimals:2,format:function(a){return"$"+a}}},make_price:function(a,b){return{currency:a,price:b}},test_same_currency:function(a,b){if(a.currency!=b.currency)throw Error("Currencies don't match: "+a.currency+" and "+
b.currency);},minus:function(a,b){if(!a||!b)return l;this.test_same_currency(a,b);return this.make_price(a.currency,a.price-b.price)},percent_off:function(a,b){if(!a||!b)return l;this.test_same_currency(a,b);var c=a.price-b.price;return"CN"==gbResources.getCustomerData("realm")?10*(1-c/a.price):100*c/a.price},format:function(a,b){if(!a||!a.price)return b;var c=this.currencies[a.currency];c||(c={decimals:2,format:function(a){return a+" "+a.currency}});var d=GBDealNotifier.DOM.span();f(d).html(c.format(GBDealNotifier.commify(a.price,
c.decimals)));return d.innerHTML}};GBDealNotifier.getListPrice=function(a,b){return"US"==b||"FR"==b||"JP"==b||"CN"==b?a.asins[0].listPrice:null};GBDealNotifier.getOurPrice=function(a,b){var c=GBDealNotifier.getListPrice(a,b),d=a.asins[0].ourPrice;return d&&"FR"!=b?"JP"==b?!c||parseFloat(d.price)<parseFloat(c.price)?d:null:d:null};GBDealNotifier.getDiscount=function(a,b){var c=GBDealNotifier.getListPrice(a,b),d=GBDealNotifier.getOurPrice(a,b),e=a.asins[0].dealPrice;return null!=c&&null!=e?GBDealNotifier.Price.minus(c,
e):null!=d&&null!=e?GBDealNotifier.Price.minus(d,e):null};GBDealNotifier.getOurPricePercentOff=function(a,b){var c=GBDealNotifier.getListPrice(a,b),d=GBDealNotifier.getOurPrice(a,b);return null!=c&&null!=d?GBDealNotifier.formatPricePercentage(GBDealNotifier.Price.percent_off(c,d)):null};GBDealNotifier.getDealPricePercentOff=function(a,b){var c=GBDealNotifier.getListPrice(a,b),d=GBDealNotifier.getOurPrice(a,b),e=a.asins[0].dealPrice;return null!=c&&null!=e?GBDealNotifier.formatPricePercentage(GBDealNotifier.Price.percent_off(c,
e)):null!=d&&null!=e?GBDealNotifier.formatPricePercentage(GBDealNotifier.Price.percent_off(d,e)):null};GBDealNotifier.round=function(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)};GBDealNotifier.Controller=GBDealNotifier.Class({signals:["cell_change","page_change","metadata_change"],__init__:function(a){GBDealNotifier.Signal.init(this);GBDealNotifier.Service.base_retry_interval=a.base_retry_interval||6E4;GBDealNotifier.Service.continue_requests=a.continue_requests||!0;this.login_uri=a.login_uri;
this.images=a.images;this.service=new GBDealNotifier.Service({marketplace_id:a.marketplace_id,customer_id:a.customer_id,session_id:a.session_id,timeout:a.timeout,includeVariations:a.includeVariations});this.buying={};this.deals=new GBDealNotifier.Model.Deals(a.deals);this.metadata=new GBDealNotifier.Model.Metadata(a.filters,a.orderings);this.browseNodes=a.browseNodes;this.ordering=a.ordering;this.statuses={available:GBDealNotifier.Service.AndDealFilter([GBDealNotifier.Service.EndDateDealFilter("now",
null),GBDealNotifier.Service.SoldOutDealFilter(!1)]),upcoming:GBDealNotifier.Service.StartDateDealFilter("now",null),sold_out:GBDealNotifier.Service.SoldOutDealFilter(!0),expired:GBDealNotifier.Service.EndDateDealFilter(null,"now")};this.varPopCloseFunction=null;this.connections=[];this.cells=1;this.cell_to_deal={};this.deal_id_to_cell={};this.pages=this.page=1;this.order=this.filter=l;this.deal_ids=[]},closeVarPopover:function(){this.varPopCloseFunction&&this.varPopCloseFunction()},setVarPopCloseFunction:function(a){this.closeVarPopover();
this.varPopCloseFunction=a},_calc_deal_ids:function(){this.deal_ids=this.metadata.get_deal_ids(this.filter,this.order);this._calc_pages()},_calc_pages:function(){this.pages=Math.ceil(this.deal_ids.length/this.cells)},set_status:function(a){var b=this;if(!b.statuses[a])throw Error("No such status '"+a+"'");b.status=a;a=b.statuses[a];var c={all:GBDealNotifier.Service.AndDealFilter([a,GBDealNotifier.Service.SlotDealFilter(["LD:ALL"])]),gbld:GBDealNotifier.Service.AndDealFilter([a,GBDealNotifier.Service.SlotDealFilter(["GBLD:ALL"])])},
d;for(d in b.browseNodes)c[d]=GBDealNotifier.Service.AndDealFilter([a,b.browseNodes[d]]);b.service.get_deal_metadata({filters:c,orderings:{start:b.ordering}},function(a){b.metadata=new GBDealNotifier.Model.Metadata(a.filters,a.orderings);b.signal("metadata_change")},function(a){GBDealNotifier.log("error="+a)})},set_filter:function(a){if(!this.metadata.filters[a])throw Error("Invalid filter: "+a);this.filter=a;this._calc_deal_ids()},set_ordering:function(a){if(!this.metadata.orderings[a])throw Error("Invalid ordering: "+
a);this.order=a;this.filter&&this._calc_deal_ids()},set_cells:function(a){if(1>a)throw Error("Invalid number of cells: "+a);this.cells=a;this._calc_pages()},prev_page:function(a){if(1==this.page)if(a)this.set_page(this.pages);else throw Error("already at first page");else this.set_page(this.page-1)},next_page:function(a){if(this.page<this.pages)this.set_page(this.page+1);else if(a)this.set_page(1);else throw Error("already at last page");},set_page_to_show_deal:function(a){if(a){var b;for(b=0;b<this.deal_ids.length&&
this.deal_ids[b]!=a;b++);b==this.deal_ids.length?(GBDealNotifier.log("couldn't find deal id "+a),this.set_page(1)):this.set_page(Math.floor(b/this.cells)+1)}else this.set_page(1)},set_page:function(a){var b;if(0===this.pages){for(a=0;a<this.cells;a++)this.signal("cell_change",a,null);this.signal("page_change",0,0,0,0,0)}else{if(1>a||Math.floor(a)!=a)throw Error("invalid page: "+a);if(a>this.pages)throw Error("page ("+a+") exceeds pages ("+this.pages+")");this.disconnect_all();this.page=a;this.cell_to_deal=
[];this.deal_id_to_cell={};this.signal("page_change",this.page,this.pages,(this.page-1)*this.cells+1,GBDealNotifier.min(this.page*this.cells,this.deal_ids.length),this.deal_ids.length);for(a=0;a<this.cells;a++)b=(this.page-1)*this.cells+a,b<this.deal_ids.length?(b=this.deal_ids[b],this.deal_id_to_cell[b]=a,b=this.deals.get_deal(b),this.cell_to_deal[a]=b,this.connect_deal_change(a,b),this.connect_deal_expire(b),this.connect_deal_status_expire(b),this.signal("cell_change",a,b)):(this.cell_to_deal[a]=
null,this.signal("cell_change",a,null));for(b=this.page*this.cells;b<(this.page+1)*this.cells&&b<this.deal_ids.length;b++)this.connect_deal_expire(this.deals.get_deal(this.deal_ids[b])),this.connect_deal_status_expire(this.deals.get_deal(this.deal_ids[b]))}},connect_deal_change:function(a,b){var c=this,d=b.connect("change",function(b){c.signal("cell_change",a,b)});c.connections.push(d)},connect_deal_expire:function(a){var b=this,c=a.connect("expire",function(a){var e,g=b.service.get_deal(a.dealID,
function(g){e.disconnect();a.load_from_deal(g)},function(a){GBDealNotifier.log("Error getting deal: "+a+" stack: "+a.stack)});e=c.connect("disconnect",function(){g.cancel()})});b.connections.push(c);(a.expired||a.loading)&&c.trigger(a)},connect_deal_status_expire:function(a){var b=this,c=a.connect("status_expire",function(a){var e,g=b.service.get_deal_status(a.dealID,function(g){e.disconnect();a.load_from_status(g)},function(a){GBDealNotifier.log("Error getting status: "+a+" stack: "+a.stack)});e=
c.connect("disconnect",function(){g.cancel()});var k,m=b.service.get_deal_asin_status2(a.dealID,function(g){k.disconnect();for(var b=a.asins,c=0;c<b.length;c++){var m=b[c];g[m.asin]&&(m.status=g[m.asin],m.status.purchaseStatus.expiresDate=new Date((new Date).getTime()+parseInt(m.status.purchaseStatus.msToExpiry,10)))}a._init_asin_statuses();a.signal("change",a)},function(g){GBDealNotifier.log("error with GetDealAsinStatus("+a.dealID+"):"+g)});k=c.connect("disconnect",function(){m.cancel()})});b.connections.push(c);
!a.status.expired||a.expired||a.loading||c.trigger(a)},disconnect_all:function(){for(var a=0;a<this.connections.length;a++)this.connections[a].disconnect();this.connections=[]},buy:function(a,b,c){var d=this,e;if(d.service.customer_id)d.buying[a.dealID]||(d.buying[a.dealID]=!0,d.service.redeem_deal(a.dealID,b,function(g){delete d.buying[a.dealID];var m=g.deal;if(b!=l)for(var p=m.asins,u=0;u<p.length;u++){var f=p[u];if(f.asin==b){e=f;break}}else e=m.asins[0];p=e.status.purchaseStatus.state;1!=g.redeemed||
p!=GBDealNotifier.waitInLineStr&&p!=GBDealNotifier.inCartStr?a.load_from_deal(g.deal):(a.cartP=new GBDealNotifier.CartPopover(m,e,d.images,c,p),d.closeVarPopover(),a.load_from_deal(g.deal),1==g.redeemed&&h.dealNotifier&&(GBDealNotifier.log("Calling dealNotifier.registerDeal("+e.asin+", "+m.dealID+")"),dealNotifier.registerDeal(e.asin,a)))},function(g){delete d.buying[a.dealID];GBDealNotifier.log("Error redeeming deal: "+g);if(null!=b)if(g=a.asins,null==g)a.status.percentClaimed=100;else for(var c=
0;c<g.length;c++){var p=g[c];if(p.asin==b){p.status.percentClaimed=100;break}}else a.status.percentClaimed=100;a.signal("change",a)}));else{var g=d.login_uri,g=g.replace(/%257BdealID%257D/,a.dealID),g=g.replace(/%257Basin%257D/,b),g=g.replace(/%257BmarketplaceID%257D/,d.service.marketplace_id),g=g.replace(/%257Bcategory%257D/,d.filter);h.location=g}}});GBDealNotifier.DOM={set_attributes:function(a,b){for(var c in b)"style"==c?a.style.cssText=b[c]:a[{"class":"className",checked:"defaultChecked",usemap:"useMap",
"for":"htmlFor",readonly:"readOnly",colspan:"colSpan",bgcolor:"bgColor",cellspacing:"cellSpacing",cellpadding:"cellPadding",valign:"vAlign",nowrap:"noWrap"}[c]||c]=b[c]},el:function(a,b,c){a=document.createElement(a);b&&GBDealNotifier.DOM.set_attributes(a,b);c&&this.appendChildren(a,c);return a},img:function(a){a=a||{};a.border=a.border||0;return this.el("img",a)},div:function(a,b){return this.el("div",a,b)},span:function(a,b){return this.el("span",a,b)},p:function(a,b){return this.el("p",a,b)},a:function(a,
b){return this.el("a",a,b)},table:function(a,b){a||(a={});a.cellpadding=a.cellpadding||0;a.cellspacing=a.cellspacing||0;a.border=a.border||0;return this.el("table",a,[this.el("tbody",null,b)])},tr:function(a,b){return this.el("tr",a,b)},td:function(a,b){return this.el("td",a,b)},td_nowrap:function(a,b){return this.el("td",a,[this.span({style:"white-space:nowrap"},b)])},br:function(a,b){return this.el("br",a,b)},hr:function(a){return this.el("hr")},select:function(a,b){return this.el("select",a,b)},
option:function(a,b){return this.el("option",a,b)},appendChildren:function(a,b){for(var c=0;c<b.length;c++){var d=b[c];if("string"==typeof d||"number"==typeof d)d=this.text(d);else if(d instanceof Array){this.appendChildren(a,d);continue}else if(null===d||d===l)continue;a.appendChild(d)}},clearChildren:function(a){for(;a.firstChild;)a.removeChild(a.firstChild)},replaceChildren:function(a,b){this.clearChildren(a);this.appendChildren.call(this,a,b)},text:function(a){return document.createTextNode(a)}};
GBDealNotifier.Widget={};GBDealNotifier.Widget.preload_img=function(a){GBDealNotifier.Widget.preload_img.div||(GBDealNotifier.Widget.preload_img.div=GBDealNotifier.DOM.div({style:"display:none"}));GBDealNotifier.Widget.preload_img.div.appendChild(GBDealNotifier.DOM.img({src:a}))};GBDealNotifier.clock={signals:["tick"]};GBDealNotifier.Signal.init(GBDealNotifier.clock);GBDealNotifier.clock.tick=function(){GBDealNotifier.clock.signal("tick")};h.setInterval(GBDealNotifier.clock.tick,250);GBDealNotifier.Timer=
function(a,b,c){var d={};d.t=a;d.noHours=c;var e={};d.onTimeoutFunction=null;d.setOnTimeoutFunction=function(a){d.onTimeoutFunction=a};d.update=function(){var a=GBDealNotifier.max(d.t.getTime()-(new Date).getTime(),0);if(0>=a&&(d.disconnect(),null!=d.onTimeoutFunction))d.onTimeoutFunction();var b=Math.floor(a/36E5);10>b&&(b="0"+b);var c=Math.floor(a/6E4%60);10>c&&!d.noHours&&(c="0"+c);a=Math.floor(a/1E3%60);10>a&&(a="0"+a);var p=":",u=":",f="";"FR"==gbResources.getCustomerData("realm")&&(p="h ",u=
"min ",f="s");d.span=GBDealNotifier.DOM.span(e);d.span.innerHTML=d.noHours?c+u+a:b+p+c+u+a+f};d.disconnect=function(){d.cx.disconnect()};d.cx=GBDealNotifier.clock.connect("tick",d.update);d.update();return d};GBDealNotifier.CheckoutTimer=function(a,b){var c={};c.span=GBDealNotifier.DOM.span();c.t=a;c.onTimeoutFunction=null;c.setOnTimeoutFunction=function(a){c.onTimeoutFunction=a};c.update=function(){var a=GBDealNotifier.max(c.t.getTime()-(new Date).getTime(),0);if(0>=a){if(c.disconnect(),null!=c.onTimeoutFunction)c.onTimeoutFunction()}else{var e=
Math.floor(a/6E4%60);10>e&&b&&(e="0"+e);a=Math.floor(a/1E3%60);10>a&&b&&(a="0"+a);var g=" "+gbResources.getString("gbd_minutes")+" ",k=" "+gbResources.getString("gbd_seconds")+" ";if(b){var g={US:":",UK:":",DE:":",FR:"m",JP:":",CN:":"},k=gbResources.getCustomerData("realm"),m=":";g[k]&&(m=g[k]);g='<span class="timeleft-large">'+m+"</span>";k=""}c.span.innerHTML='<span class="timeleft-large">'+e+"</span>"+g+'<span class="timeleft-large">'+a+"</span>"+k}};c.disconnect=function(){c.cx.disconnect()};
c.cx=GBDealNotifier.clock.connect("tick",c.update);c.update();return c};GBDealNotifier.truncate_text=function(a){if(a.scrollHeight>a.clientHeight||a.scrollWidth>a.clientWidth)a.title=a.innerHTML;for(;a.scrollHeight>a.clientHeight||a.scrollWidth>a.clientWidth;)a.innerHTML=a.innerHTML.replace(/\s*\S{0,10}$/,"...")};GBDealNotifier.truncate_description=function(a,b){var c="",c=a.innerHTML;if(null==c)if("string"==typeof a)c=a;else return"";c.length>b&&(c=c.substr(0,b).split(" "),c[c.length-1]="",c=c.join(" "),
c=c.replace(/[^\w\d]*$/,""),c=c.substr(0,c.length-1)+"...",a.title=a.innerHTML,a.innerHTML=c);return c};GBDealNotifier.help=function(a){var b;a=GBDealNotifier.DOM.div(null,[b=GBDealNotifier.DOM.img({src:a})]);GBDealNotifier.popoverTrigger(b,"amazonPopoverTrigger",{showOnHover:!0,showCloseButton:!1,location:["left","bottom"],width:300,literalContent:h.gbResources.getString("gbd_ld_help")});return a};GBDealNotifier.CombinationGenerator=GBDealNotifier.Class({__init__:function(a,b){this.a=[];this.r=this.n=
null;if(b>a)GBDealNotifier.log("ERROR: r > n");else if(1>a)GBDealNotifier.log("ERROR: n < 1");else{this.n=a;this.r=b;this.a=Array(b);var c=this.getFactorial(a),d=this.getFactorial(b),e=this.getFactorial(a-b);this.total=c/(d*e);this.reset()}},reset:function(){for(var a=0;a<this.a.length;a++)this.a[a]=a;this.numLeft=this.total},getNumLeft:function(){return this.numLeft},hasMore:function(){return 0==this.numLeft?!1:!0},getTotal:function(){return this.total},getFactorial:function(a){for(var b=1;1<a;a--)b*=
a;return b},getNext:function(){if(this.numLeft==this.total)return--this.numLeft,this.a;for(var a=this.r-1;this.a[a]==this.n-this.r+a;)a--;this.a[a]+=1;for(var b=a+1;b<this.r;b++)this.a[b]=this.a[a]+b-a;--this.numLeft;return this.a}});GBDealNotifier.PStatus=GBDealNotifier.Class({__init__:function(a){this.deal=a;this.widget=a.widget;this.popover=a.popover;this.stateAsins={};for(var b=0;b<this.deal.asins.length;b++){var c=this.deal.asins[b],d=GBDealNotifier.getPurchaseState(a,c);this.stateAsins[d]==
l&&(this.stateAsins[d]=[]);this.stateAsins[d].push(c)}this.stateAsins[GBDealNotifier.inCartStr]&&this.stateAsins[GBDealNotifier.inCartStr].sort(this.sortByAsinTimes);this.stateAsins[GBDealNotifier.pendingAtcStr]&&this.stateAsins[GBDealNotifier.pendingAtcStr].sort(this.sortByAsinTimes)},sortByAsinTimes:function(a,b){return a.status.purchaseStatus.expiresDate-b.status.purchaseStatus.expiresDate},getCount:function(a,b){var c=new Date,d=0;if(this.stateAsins[a]&&this.stateAsins[a].length)for(var e=0;e<
this.stateAsins[a].length;e++){var g=this.stateAsins[a][e].status.purchaseStatus.expiresDate;g==l&&(g=c);b&&g.getTime()>c.getTime()?d++:b||d++}return d},getTime:function(a,b){var c=new Date;if(this.stateAsins[b])for(var d=0;d<this.stateAsins[b].length;d++){var e=this.stateAsins[b][d].status.purchaseStatus.expiresDate;if(a!=l){if(this.stateAsins[b][d].asin==a)return e}else if(e.getTime()>c.getTime())return this.asin=this.stateAsins[b][d],e}return null},getTimerMessage:function(a,b,c){var d=null;a!=
l&&null!=a&&(this.asinString=a);a=GBDealNotifier.inCartStr;c&&(a=GBDealNotifier.pendingAtcStr);a=this.getTime(this.asinString,a);a=GBDealNotifier.Timer(a,null,!0);c?d=GBDealNotifier.DOM.div({"class":"status_msg_content"},[gbResources.getString("gbd_deal_atc_time_part1")+" ",GBDealNotifier.DOM.span({"class":"status_timer"},[a.span])," "+gbResources.getString("gbd_deal_atc_time_part2")?gbResources.getString("gbd_deal_atc_time_part2"):""]):(c="null"!=gbResources.getString("gbd_check_out_within_time_part2_single")?
gbResources.getString("gbd_check_out_within_time_part2_single"):"",null!=b&&1<b&&(c="null"!=gbResources.getString("gbd_check_out_within_time_part2_plural")?gbResources.getString("gbd_check_out_within_time_part2_plural"):""),d=GBDealNotifier.DOM.div({"class":"status_msg_content"},[gbResources.getString("gbd_check_out_within_time_part1")+" ",GBDealNotifier.DOM.span({"class":"status_timer"},[a.span])," "+c]));return d},getItemMsg:function(a,b){var c=h.gbResources.getString("gbd_deal_in_cart"),d=h.gbResources.getString("gbd_all_options_in_cart");
"wait"==b&&(c=h.gbResources.getString("gbd_you_are_waitlisted"),d=h.gbResources.getString("gbd_all_are_waitlisted"));c=GBDealNotifier.DOM.span({"class":"item_msg"},[c]);if(1<this.deal.asins.length){var e=null;1<a&&a==this.deal.asins.length?e=d:1==a?(e=h.gbResources.getString("gbd_1_option_in_cart"),"wait"==b&&(e=h.gbResources.getString("gbd_1_option_waitlisted"))):1<a&&(e=h.gbResources.getString("gbd_num_options_in_cart",{num:a}),"wait"==b&&(e=h.gbResources.getString("gbd_num_options_in_waitlist",
{num:a})));f(c).html(e)}return c},getMixedItemMsg:function(a,b){var c=GBDealNotifier.DOM.span({"class":"item_msg_normal"},[]),d=GBDealNotifier.DOM.span({},[GBDealNotifier.DOM.span({style:"font-weight:bold;"},[a])," "+h.gbResources.getString("gbd_in_cart")+" "]),e=GBDealNotifier.DOM.span({},[GBDealNotifier.DOM.span({style:"font-weight:bold;"},[b])," "+h.gbResources.getString("gbd_on_waitlist")]),g=this.getTime(null,GBDealNotifier.inCartStr),g=GBDealNotifier.Timer(g,null,!0),g=GBDealNotifier.DOM.span({"class":"timer"},
[GBDealNotifier.DOM.span({style:"font-color:#666666 !important;"},[h.gbResources.getString("gbd_check_out_in")+" "]),GBDealNotifier.DOM.span({"class":"status_timer"},[g.span])]);GBDealNotifier.DOM.appendChildren(c,[d,g,GBDealNotifier.DOM.br(),e]);return c},showBuying:function(){GBDealNotifier.DOM.replaceChildren(this.buyButtonContainer,[GBDealNotifier.DOM.img({id:"buying-"+this.deal.dealID,alt:h.gbResources.getString("csld-checking_deal_status"),style:"display: inline;",src:gbResources.getImage("spinner")}),
GBDealNotifier.DOM.span({style:"color: #E68221;font-weight: bold;font-size: 10px;"},[h.gbResources.getString("csld-checking_deal_status_alt")])]);this.buy_button.onclick=null},getContent:function(){var a=this,b=a.getCount(GBDealNotifier.inCartStr,!1),c=a.getCount(GBDealNotifier.inCartStr,!0),d=a.getCount(GBDealNotifier.waitInLineStr,!1),e=a.getCount(GBDealNotifier.pendingAtcStr,!0),g=a.getCount(GBDealNotifier.pendingAtcStr,!1);if(0<e)return a.buy_button=GBDealNotifier.DOM.img({style:"cursor:pointer;display: inline;",
src:gbResources.getImage("add_to_cart")}),a.buyButtonContainer=GBDealNotifier.DOM.div({style:'opacity:1.0;filter:"alpha(opacity=100)"cursor:pointer'},[a.buy_button]),a.buy_button.onclick=function(g){g&&(g.stopPropagation(),g.preventDefault());a.widget.cx.buy(a.deal,a.asin.asin,!0);a.showBuying();return!1},b=a.getTimerMessage(null,e,!0),GBDealNotifier.isPrimeEligible(a.deal)&&("US"==gbResources.getCustomerData("realm")||"US"!=gbResources.getCustomerData("realm")&&gbResources.getCustomerData("isPrimeMember"))&&
(a.deal.prime=GBDealNotifier.DOM.span({style:"display:block; position:absolute; left: 115px;"},[GBDealNotifier.DOM.img({alt:h.gbResources.getString("csld-prime_eligible_alt"),id:"prime-badge-"+a.deal.dealID,style:"display: inline;",src:gbResources.getImage("prime")})])),GBDealNotifier.DOM.div({style:"position:relative;"},[a.deal.prime,GBDealNotifier.DOM.div({style:"position:relative;"},[a.buyButtonContainer,b])]);if(0==b&&0==d&&0==g)return null;if(0==c&&0==d)return GBDealNotifier.DOM.div({"class":"status_content"},
[GBDealNotifier.DOM.img({id:"buying-"+a.deal.dealID,alt:h.gbResources.getString("csld-checking_deal_status"),style:"display: inline;",src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span({style:"color: #E68221;font-weight: bold;font-size: 10px;"},[h.gbResources.getString("csld-checking_deal_status_alt")])]);b=e=null;0<c&&0==d?(e=a.getItemMsg(c,"cart"),b=a.getTimerMessage(null,c,!1)):e=0<d&&0==c?a.getItemMsg(d,"wait"):a.getMixedItemMsg(c,d);if(1<a.deal.asins.length&&!a.deal.status.ended){var k=
null,k=GBDealNotifier.DOM.span({"class":"options_link"},[h.gbResources.getString("gbd_select_more_options")]);a.popOver||(a.popOver=new GBDealNotifier.VariationPopover(k,a.deal,a.widget.cx))}return GBDealNotifier.DOM.div({"class":"status_content"},[e,GBDealNotifier.DOM.br(),b,k])}});GBDealNotifier.CartPopover=GBDealNotifier.Class({__init__:function(a,b,c,d,e){var g=this;g.deal=a;g.asin=b;g.waitlist=d;g.state=e;g.popover=g.getPopoverDiv();a=835;b=!0;c=h.gbResources.getString("gbd_close_and_continue_shopping");
g.state==GBDealNotifier.waitInLineStr&&(a=410,c=null,b=!1);var k={showCloseButton:!0,width:a,height:250,modal:b,closeText:c,closeEventInclude:"CLICK_OUTSIDE",location:"centered",locationAlign:"middle",literalContent:g.popover,onHide:function(){g.onHide()}};"object"===typeof amznJQ?amznJQ.available("popover",function(){g.pop=f.AmazonPopover.displayPopover(k)}):g.pop=f.AmazonPopover.displayPopover(k);g.timer&&g.timer.setOnTimeoutFunction(function(){g.pop&&g.pop.close()})},getPopoverDiv:function(){var a=
"background:url("+gbResources.getImage("sprite_site_wide")+") -30px -189px;",b=h.gbResources.getString("gbd_1_deal_to_cart"),c="";this.state==GBDealNotifier.waitInLineStr&&(b=h.gbResources.getString("gbd_joined_waitlist"),c="font-size: 15px; top:-3px; left:23px;",a="background:url("+gbResources.getImage("sprite_site_wide")+") -139px -189px; height: 20px; width: 20px;");var d=null;"DE"==gbResources.getCustomerData("realm")&&(d="font-size: 15px !important;");var e=GBDealNotifier.DOM.br(),g=null,k=null,
m="width: 280px;",p="image_title_price";this.state==GBDealNotifier.waitInLineStr?(p="image_title_price_waitlist",k=this.get_inner_message(),m="width: 410px;",e=null):g=this.get_timer_atc_table();return GBDealNotifier.DOM.div({},[GBDealNotifier.DOM.div({style:"position:relative;"},[GBDealNotifier.DOM.div({"class":"greencheck_img",style:a},[GBDealNotifier.DOM.span({"class":"cart-popover-label",style:c+d},[b])])]),e,GBDealNotifier.DOM.table({"class":"cart-popover-table"},[GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({"class":p,
style:m},[this.get_image_title_price_table()]),g]),k])])},get_position_chance:function(){var a=null;if(this.asin.status.purchaseStatus.waitListStatus==l||null==this.asin.status.purchaseStatus.waitListStatus)return null;var b=this.asin.status.purchaseStatus.waitListStatus,c=b.inCartIndicator,b=b.position;if(c==l||null==c||b==l||null==b)return null;if(this.asin.status.purchaseStatus.waitListStatus!=l){a=this.asin.status.purchaseStatus.waitListStatus.inCartIndicator;b=this.asin.status.purchaseStatus.waitListStatus.position;
500<b?b="500+":(b=f("<span />").html(h.gbResources.getString("gbd_position_num",{num:b})),b=b[0]);var d=GBDealNotifier.DOM.td({"class":"pc_value"},[b]);"CN"==gbResources.getCustomerData("realm")&&f(d).css("font-weight","");var e=GBDealNotifier.DOM.td({"class":"pc_label"},[h.gbResources.getString("gbd_place_on_waitlist")]),c=GBDealNotifier.DOM.td({"class":"pc_value"},[h.gbResources.getString("gbd_"+a.toLowerCase())]),b=GBDealNotifier.DOM.td({"class":"pc_label"},[h.gbResources.getString("gbd_chance_at_deal")]);
"CN"==gbResources.getCustomerData("realm")?(a=e,e=b):(a=d,d=e,e=c,c=b);a=GBDealNotifier.DOM.div({"class":"waitlist_position_chance"},[GBDealNotifier.DOM.br(),GBDealNotifier.DOM.table({},[GBDealNotifier.DOM.tr({},[a,GBDealNotifier.DOM.td(null,[" "]),d]),GBDealNotifier.DOM.tr({},[e,GBDealNotifier.DOM.td(null,[" "]),c])])])}return a},get_inner_message:function(){var a=GBDealNotifier.DOM.span({"class":"waitlist_message"},[h.gbResources.getString("gbd_continue_shopping_alert_msg")]);this.state!=GBDealNotifier.waitInLineStr||
this.waitlist||f(a).html(h.gbResources.getString("gbd_forced_waitlist_msg"));var b="background:url("+gbResources.getImage("sprite_site_wide")+") -117px -189px;",b=GBDealNotifier.DOM.div({"class":"bubble",style:b},[" "]),c=GBDealNotifier.DOM.a({href:"#","class":"ap_custom_close"},[GBDealNotifier.DOM.img({alt:h.gbResources.getString("gbd_continue_shopping"),style:"display: inline;",src:gbResources.getImage("continue_shopping")})]);return GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({},[GBDealNotifier.DOM.table({"class":"inner_message_waitlist"},
[GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({style:"padding: 8px 0 8px 8px;"},[b]),GBDealNotifier.DOM.td({style:"padding: 8px;"},[a])]),GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({style:"padding: 0 8px 8px;",colSpan:2},[c])])])])])},get_timer_atc_table:function(){return GBDealNotifier.DOM.td({},[GBDealNotifier.DOM.table({"class":"inner-cart-popover-table"},[GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({style:"text-align:left; padding:10px;"},[GBDealNotifier.DOM.a({href:"/gp/cart/view.html/ref=gno_cart"},
[GBDealNotifier.DOM.img({alt:h.gbResources.getString("gbd_view_cart_proceed"),style:"display: inline;",src:gbResources.getImage("view_cart_proceed")})]),this.get_timer_message_table()])])])])},get_timer_message_table:function(){var a=null;h.gbResources.getFeature("pc_deal_notifier")&&"C"!=h.gbResources.getFeature("pc_deal_notifier")&&(a=h.gbResources.getString("gbd_time_before_alert_msg",{time:10}));return GBDealNotifier.DOM.table({"class":"inner-msg"},[GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({style:"padding: 8px 8px 0px;"},
[GBDealNotifier.DOM.div({"class":"alert",style:"background:url("+gbResources.getImage("sprite_site_wide")+");"},[])]),GBDealNotifier.DOM.td({"class":"msgtitle"},[h.gbResources.getString("gbd_checkout_within")])]),GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td(null,[]),GBDealNotifier.DOM.td({"class":"timeleft"},[this.timeRemaining()])]),GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td(null,[]),GBDealNotifier.DOM.td({"class":"smallprint",style:"width:100%;"},[a])])])},get_image_title_price_table:function(){var a=
this.asin.imageURL,a=a=GBDealNotifier.resizeImage(a,85),b=null;this.deal.detail.title&&(b=GBDealNotifier.truncate_description(this.deal.detail.title,65));var c=null;this.asin.listPrice?c=GBDealNotifier.Price.format(this.asin.listPrice):this.asin.ourPrice&&(c=GBDealNotifier.Price.format(this.asin.ourPrice));var d=GBDealNotifier.DOM.br(),e=h.gbResources.getString("csld-multi-cat-list_price")+" ";"UK"==gbResources.getCustomerData("realm")&&(e=h.gbResources.getString("csld-multi-cat-price")+" ");var g=
h.gbResources.getString("csld-deal_price")+" ",k=null;this.state==GBDealNotifier.waitInLineStr&&(d=" ",e=g=null,k=this.get_position_chance());var m=null;this.state==GBDealNotifier.waitInLineStr&&(m="width:247px");var p="";c&&(p=[GBDealNotifier.DOM.span({"class":"cart-popover-listprice"},[e]),GBDealNotifier.DOM.span({"class":"cart-popover-prevprice"},[c])]);c=GBDealNotifier.DOM.span({style:"white-space:nowrap"},[GBDealNotifier.Price.format(this.asin.dealPrice)]);return GBDealNotifier.DOM.table({style:"padding-top:10px;"},
[GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({style:"padding-right: 10px; vertical-align: top;"},[GBDealNotifier.DOM.img({alt:h.gbResources.getString("gbd_deal_image"),style:"display: inline",src:a})]),GBDealNotifier.DOM.td({style:"vertical-align: top;"+m},[GBDealNotifier.DOM.span({"class":"cart-popover-asintitle"},[b]),GBDealNotifier.DOM.p(null,[]),p,d,GBDealNotifier.DOM.span({"class":"cart-popover-dealprice"},[g,c]),k])])])},timeRemaining:function(){this.timer_div=GBDealNotifier.DOM.div({"class":"timeleft"},
[]);this.updateTimeRemaining();return this.timer_div},updateTimeRemaining:function(){var a=this.deal,b=this.asin;this.timer&&this.timer.disconnect();a.status.ended?this.timer=null:(a=parseInt(b.status.purchaseStatus.msToExpiry,10),b=new Date,b.setTime(b.getTime()+a),this.timer=GBDealNotifier.CheckoutTimer(b,!1),GBDealNotifier.DOM.replaceChildren(this.timer_div,[this.timer.span]))},onHide:function(){this.timer&&this.timer.disconnect()}});GBDealNotifier.VariationPopover=GBDealNotifier.Class({__init__:function(a,
b,c){var d=this;d.deal=b;d.cx=c;d.dropDownOptions={};d.currentSelections={};c=b=0;"GBLD_WIDGET"==d.cx.name?(b=-137,c=-156):1==d.cx.cells?(b=-174,c=-197):(b=-79,c=-221);GBDealNotifier.popoverTrigger(a,"amazonPopoverTrigger",{showOnHover:!1,locationAlign:"middle",location:"auto",locationOffset:[b,c],literalContent:" ",closeEventInclude:"CLICK_OUTSIDE",onShow:function(a){d.onShow(a)},onHide:function(){d.onHide()},title:'<span style="color: #E47911;">'+h.gbResources.getString("csld-deal_options")+"</span>",
closeText:h.gbResources.getString("csld-close")})},onShow:function(a){this.cx.setVarPopCloseFunction(a.close);this.selection={};this.selectors={};this.selection_span={};this.selectionDropDownElements={};this.asinsForSelection();this.allValidCombinations={};this.getAllCombinations();var b=a.find(".ap_sub_content");0==b.length&&(b=a.find(".ap_content"));a=this.progressBar();var c=GBDealNotifier.DOM.div({style:"padding-top: 4px;"},[GBDealNotifier.DOM.a({href:h.gbResources.getString("csld-restrictions_link"),
style:"font-size: 11px; text-decoration: none;"},[h.gbResources.getString("csld-restrictions_apply")])]);if("US"==this.marketplaceID||"UK"==this.marketplaceID)c=GBDealNotifier.DOM.div({style:"position:relative; left:0px; font-family: verdana;"},[h.gbResources.getString("gbd_ld_rules")]);b.empty().append(GBDealNotifier.DOM.table({width:"430"},[GBDealNotifier.DOM.tr({valign:"top"},[GBDealNotifier.DOM.td({width:"120"},[this.image(),a,this.timeRemaining()]),GBDealNotifier.DOM.td({width:"10"}),GBDealNotifier.DOM.td({},
[this.title(),this.selector(),this.price(),GBDealNotifier.DOM.div({style:"margin-top:10px; position: relative;",height:"22"},[this.buyButton(),this.statusBox(),GBDealNotifier.DOM.br(),c])])])]));this.container=b;this.change_cx=this.deal.connect("change",this,"deal_change")},getSelectionCombinations:function(a,b){var c=[];0==b&&a.length;for(var d=new GBDealNotifier.CombinationGenerator(a.length,b),c="",e=[];d.hasMore();){for(var c=d.getNext(),g=[],k=0;k<c.length;k++)g.push(a[c[k]]);c=g.join(";");e.push(c)}return e},
onHide:function(){this.timer.cx.disconnect();this.change_cx.disconnect()},deal_change:function(){this.asinsForSelection();this.update()},update:function(){this.updateImage();this.updatePrice();this.updateSelectionBoxes();this.updateBuyButton();this.updateStatusBox();this.updateProgressBar();this.updateTimeRemaining()},image:function(){this.img=GBDealNotifier.DOM.img();this.updateImage();return GBDealNotifier.DOM.div(null,[this.img])},updateImage:function(){var a=this.imageURLForCurrentSelection(),
a=a?a.replace(/\.((_.*_)\.)?(gif|jpg)$/,".$2_AA120_.$3"):gbResources.getImage("no_image")||"http://g-ecx.images-amazon.com/images/G/01/x-site/icons/no-img-sm.gif";this.img.src=a},imageURLForCurrentSelection:function(){var a;if(this.selectedAsin)return this.selectedAsin.imageURL;var b=null;for(a=0;a<this.selectedAsins.length;a++)if(b){if(b!=this.selectedAsins[a].imageURL){b=null;break}}else b=this.selectedAsins[a].imageURL;if(b)return b;for(var c in this.selection)if(b=this.imageURLForSelection(c,
this.selection[c]))return b;return this.deal.detail.imageAsin},imageURLForSelection:function(a,b){for(var c,d=0;d<this.deal.asins.length;d++){var e=this.deal.asins[d];if(e.variationData[a]==b)if(c){if(c!=e.imageURL)return null}else c=e.imageURL}return c},progressBar:function(){this.progressBarInner=GBDealNotifier.DOM.div({style:"position:absolute;background-color:#C9D7E4;height:19px;"});this.progressBarText=GBDealNotifier.DOM.div({style:"font-size: 9px;overflow:hidden;position:absolute;padding:2px 0 0 0;text-align:center;vertical-align:middle;width:100%"});
this.progressBarOuter=GBDealNotifier.DOM.div({style:"border:1px solid #C9D7E4;height: 19px;position: relative;margin-top:10px;width: 118px;"},[this.progressBarInner,this.progressBarText]);this.updateProgressBar();return this.progressBarOuter},updateProgressBar:function(){this.deal.limitedQuantity?this.selectedAsins.length==this.deal.asins.length?this.showPercentClaimed(this.deal.status.percentClaimed):this.selectedAsin?this.showPercentClaimed(this.selectedAsin.status.offerServiceSoldOut?100:this.selectedAsin.status.percentClaimed):
this.showPercentClaimed(null):this.showPercentClaimed(null)},showPercentClaimed:function(a){a=Math.round(a);null!=a?(this.progressBarOuter.style.visibility="",this.progressBarInner.style.width=a+"%",this.progressBarText.innerHTML=h.gbResources.getString("gbd_percent_now_claimed",{percent:a})):this.progressBarOuter.style.visibility="hidden"},timeRemaining:function(){this.timer_div=GBDealNotifier.DOM.div({style:"font-size:9px;text-align:center; margin-top: 5px;"});this.updateTimeRemaining();return this.timer_div},
updateTimeRemaining:function(){this.timer&&this.timer.cx.disconnect();if(this.deal.status.ended)this.timer_div.innerHTML=h.gbResources.getString("csld-expired_status"),this.timer=null;else{var a=this.deal;this.timer=GBDealNotifier.Timer(a.status.endDate);this.timer.span.id="time-remaining-"+a.dealID;this.timer.span.style.fontWeight="bold";GBDealNotifier.DOM.replaceChildren(this.timer_div,[h.gbResources.getString("csld_remaining")+" ",this.timer.span," "+h.gbResources.getString("csld_remaining_part2")])}},
title:function(){return GBDealNotifier.DOM.span({style:"font-weight:bold"},[this.deal.detail.title])},selector:function(){var a=this.deal.asins;this.options={};this.color_images={};for(var b=0;b<a.length;b++){var c=a[b].variationData,d;for(d in c){var e=this.options[d];e===l&&(this.options[d]=e={});e[c[d]]=1;"Color"==d&&(this.color_images[d]=a[b].imageURL)}}a=[];b=l;for(d in this.options)"Color"==d?b=this.dropdownSelector(d):a.push(this.dropdownSelector(d));b!=l&&a.push(b);return GBDealNotifier.DOM.div(null,
a)},colorSelector:function(a){},dropdownSelector:function(a){var b=this,c=[GBDealNotifier.DOM.option(null,[""])];c[0].value="Select";c[0].text=h.gbResources.getString("csld-select");var d=[],e;for(e in b.options[a])d.push(e);d.sort(b.numOrderAsc);b.dropDownOptions[a]==l&&(b.dropDownOptions[a]=[]);for(e=0;e<d.length;e++){var g=GBDealNotifier.DOM.option(null,[d[e]]);c.push(g);b.dropDownOptions[a].push(g)}var k=b.selectors[a]||GBDealNotifier.DOM.select(null,c);b.selectors[a]||(b.selectors[a]=k);b.selectionDropDownElements[a]=
k;k.onchange=function(){b.selectionChange(a,b.selectors[a][k.selectedIndex].value,b.selectors[a][k.selectedIndex].text)};b.selection_span[a]=GBDealNotifier.DOM.span({style:"color:#E47911"});return GBDealNotifier.DOM.div({style:"margin-top: 10px"},[GBDealNotifier.DOM.span({style:"font-weight: bold; font-size: 13px;"},[gbResources.getString("csld-common-select_key",{key:a}),b.selection_span[a]]),GBDealNotifier.DOM.br(),k])},isCurrentlyValidOption:function(a,b){return this.validOptions&&this.validOptions[a]&&
1==this.validOptions[a][b]?!0:!1},resetAllOtherOptions:function(a){for(var b in this.selectionDropDownElements)if(b!=a){var c=this.selectionDropDownElements[b];c&&(c.selectedIndex=0,c.onchange())}},selectionChange:function(a,b,c){"Select"!=b?(b=!1,this.isCurrentlyValidOption(a,c)||(b=!0),this.currentSelections[a]=c,this.selection[a]=c,f(this.selection_span[a]).html(c),b&&this.resetAllOtherOptions(a)):(delete this.currentSelections[a],delete this.selection[a],f(this.selection_span[a]).html(""));this.asinsForSelection();
this.updateDropDownStyles(a,c);this.update()},getAllCombinations:function(){for(var a=0;a<this.deal.asins.length;a++){for(var b=this.deal.asins[a],c=b.variationData,d=this.getSortedKeys(c),e=[],g=0;g<d.length;g++){var k=d[g];e.push(k+":"+c[k])}c=this.combine(e);for(g=0;g<c.length;g++)c[g]=c[g].join(";"),d=c[g],this.allValidCombinations[d]||(this.allValidCombinations[d]=[]),this.allValidCombinations[d].push(b)}},numOrderAsc:function(a,b){var c=parseInt(a),d=parseInt(b);return isNaN(c)&&isNaN(d)?a>
b?1:a<b?-1:0:isNaN(c)?1:isNaN(d)?-1:c>d?1:c<d?-1:0},getSortedKeys:function(a){var b=[],c;for(c in a)b.push(c);b.sort();return b},asinsForSelection:function(){this.selectedAsins=[];for(var a=0;a<this.deal.asins.length;a++){var b=this.deal.asins[a],c=!0,d;for(d in this.selection)if(b.variationData&&b.variationData[d]!=this.selection[d]){c=!1;break}c&&this.selectedAsins.push(b)}this.selectedAsins=this.uniqueAsinArray(this.selectedAsins);if(1==this.selectedAsins.length){this.selectedAsin=this.selectedAsins[0];
this.selection={};for(var e in this.selectedAsin.variationData)this.selection[e]=this.selectedAsin.variationData[e];this.updateSelection();this.available=100>this.selectedAsin.status.percentClaimed&&!this.selectedAsin.offerServiceSoldOut&&!this.deal.status.ended&&100>this.deal.status.percentClaimed?!0:!1}else this.selectedAsin=null,this.available=!1,this.updateSelection()},uniqueAsinArray:function(a){var b={},c=[];if(!a)return c;for(var d=0;d<a.length;d++){var e=a[d];b[e.asin]=e}a=this.getSortedKeys(b);
for(d=0;d<a.length;d++)c.push(b[a[d]]);return c},updateSelection:function(){for(var a in this.selection_span)this.selection[a]!=l?f(this.selection_span[a]).html(this.selection[a]):f(this.selection_span[a]).html("");for(a in this.selectors)if(this.selectors[a].value=this.selection[a]||"",this.selection[a]&&!this.selectors[a].value)for(var b=0;b<this.selectionDropDownElements[a].options.length;b++)this.selectionDropDownElements[a].options[b].text==this.selection[a]&&(this.selectors[a].selectedIndex=
b)},updateDropDownStyles:function(a,b){this.getValidOptions();for(var c in this.dropDownOptions)for(var d=0;d<this.dropDownOptions[c].length;d++){var e=this.dropDownOptions[c][d];if(null!=e){var g=e.value||e.text;1>=this.currentSelections.length&&c==a&&g==b||this.validOptions[c]&&1==this.validOptions[c][g]?(e.setAttribute("style","color: #000000;"),e.value||e.style.setAttribute("color","#000000")):(e.setAttribute("style","color: #afafaf;"),e.value||e.style.setAttribute("color","#afafaf"))}}},getValidOptions:function(){this.validOptions=
{};this.selectableAsins=this.getSelectableAsins();for(var a=0;a<this.selectableAsins.length;a++){var b=this.selectableAsins[a];if(null!=b)for(var c in b.variationData){var d=b.variationData[c];this.validOptions[c]==l&&(this.validOptions[c]={});this.validOptions[c][d]=1}}},getSelectableAsins:function(){var a=[],b=this.getSortedKeys(this.currentSelections);if(0==b.length)return this.selectedAsins;for(var c=[],d=0;d<b.length;d++){var e=b[d],g=this.currentSelections[e];c.push(e+":"+g)}d=b.length;e=this.getSortedKeys(this.dropDownOptions).length;
d>=e&&(d=e-1);b=this.getSelectionCombinations(c,d);c={};for(d=0;d<b.length;d++)if(e=b[d],(e=this.allValidCombinations[e])&&0<e.length)for(g=0;g<e.length;g++){var k=e[g];k&&(c[k.asin]=k)}b=this.getSortedKeys(c);for(d=0;d<b.length;d++)e=b[d],g=c[e],a.push(g);return a},price:function(){this.priceBlock=GBDealNotifier.DOM.div({style:"margin-top: 10px"});this.updatePrice();return this.priceBlock},updatePrice:function(){this.selectedAsin?this.updatePriceSingleAsin():1<this.selectedAsins.length?this.updatePriceRange():
this.updatePriceNoAsins()},updatePriceSingleAsin:function(){var a=this.selectedAsin;if(!a.offerServiceSoldOut&&a.dealPrice&&a.dealPrice.price){var b=a.listPrice,c=a.ourPrice,d=a.dealPrice,e=GBDealNotifier.Price.minus(b,d),g=GBDealNotifier.Price.minus(c,d),a=GBDealNotifier.formatPricePercentage(GBDealNotifier.Price.percent_off(b,d)),k=GBDealNotifier.formatPricePercentage(GBDealNotifier.Price.percent_off(c,d)),b=GBDealNotifier.Price.format(b),c=GBDealNotifier.Price.format(c),d=GBDealNotifier.Price.format(d);
GBDealNotifier.Price.format(e);GBDealNotifier.Price.format(g);e=[];e.push(GBDealNotifier.DOM.span({id:"list-price-popover",style:"font-size: 11px;color: #666666;text-decoration: line-through;"},[b||c]));e.push(" ");e.push(GBDealNotifier.DOM.span({id:"deal-price-popover",style:"font-size: 13px;color: #990000;"},[d]));e.push(" ");e.push(GBDealNotifier.DOM.span({id:"percent-off-popover",style:"font-size: 11px;color: #990000;"},[h.gbResources.getString("csld-percent_off",{discountPercentage:a||k})]));
GBDealNotifier.DOM.replaceChildren(this.priceBlock,e)}else this.updatePriceNoAsins()},updatePriceRange:function(){for(var a=null,b=null,c=0;c<this.selectedAsins.length;c++){var d=this.selectedAsins[c];if(!(100<=d.status.percentClaimed||d.offerServiceSoldOut)&&d.dealPrice&&d.dealPrice.price){var e=parseFloat(d.dealPrice.price);if(!b||e>parseFloat(b.price))b=d.dealPrice;if(!a||e<parseFloat(a.price))a=d.dealPrice}}a&&b?a==b?GBDealNotifier.DOM.replaceChildren(this.priceBlock,[GBDealNotifier.DOM.span({style:"color:#900;font-size:13px"},
[GBDealNotifier.Price.format(a)])]):GBDealNotifier.DOM.replaceChildren(this.priceBlock,[GBDealNotifier.DOM.span({style:"color:#900;font-size:13px"},[GBDealNotifier.Price.format(a),"-",GBDealNotifier.Price.format(b)])]):this.updatePriceNoAsins()},updatePriceNoAsins:function(){var a=[],b;for(b in this.selection)a.push(GBDealNotifier.DOM.span({style:"font-weight: bold"},[b,": ",GBDealNotifier.DOM.span({style:"color:#B00"},[this.selection[b]])])),a.push(GBDealNotifier.DOM.br())},updateSelectionBoxes:function(){var a=
!1;this.cx.buying[this.deal.dealID]&&(a=!0);for(var b in this.selectors)this.selectors[b].disabled=a},buyButton:function(){this.buy_button=GBDealNotifier.DOM.img({style:"cursor:pointer;display: inline;",src:gbResources.getImage("add_to_cart")});this.buyButtonContainer=GBDealNotifier.DOM.div({},this.buy_button);this.updateBuyButton();return this.buyButtonContainer},updateBuyButton:function(){this.cx.buying[this.deal.dealID]?this.showBuying():this.showBuyButton()},showBuyButton:function(){var a=this,
b=GBDealNotifier.getPurchaseState(null,a.selectedAsin),c=null,d=null;if(a.selectedAsin&&b==GBDealNotifier.waitInLineStr)a.buy_button.src=gbResources.getImage("add_to_cart"),a.buy_button.alt=h.gbResources.getString("csld-add_to_cart"),a.buy_button.onclick=null,a.buy_button.style.opacity=.5,a.buy_button.style.cursor="default",a.buy_button.style.filter="alpha(opacity=50)",d=GBDealNotifier.DOM.div({style:"font-weight: bold;font-size: 11px;"},[h.gbResources.getString("gbd_this_option_waitlisted")]);else if(a.selectedAsin&&
b==GBDealNotifier.inCartStr)if(0<a.selectedAsin.status.purchaseStatus.msToExpiry)a.buy_button.src=gbResources.getImage("add_to_cart"),a.buy_button.alt=h.gbResources.getString("csld-add_to_cart"),a.buy_button.onclick=null,a.buy_button.style.opacity=.5,a.buy_button.style.cursor="default",a.buy_button.style.filter="alpha(opacity=50)",c=GBDealNotifier.DOM.span({style:"font-weight: bold;font-size: 13px;"},[" "+h.gbResources.getString("gbd_in_your_cart")]),d=a.getStatusContent(!1);else{GBDealNotifier.DOM.replaceChildren(a.buyButtonContainer,
[GBDealNotifier.DOM.img({id:"buying-"+a.deal.dealID,alt:h.gbResources.getString("csld-checking_deal_status"),style:"display: inline;",src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span({style:"color: #E68221;font-weight: bold;font-size: 10px;"},[h.gbResources.getString("csld-checking_deal_status_alt")])]);a.buy_button.onclick=null;return}else if(a.selectedAsin&&a.available&&!GBDealNotifier.isClaimed(null,a.selectedAsin)||b==GBDealNotifier.pendingAtcStr)if(0<a.selectedAsin.status.purchaseStatus.msToExpiry||
a.selectedAsin.status.purchaseStatus.state==GBDealNotifier.expiredStr||a.selectedAsin.status.purchaseStatus.state==GBDealNotifier.availableStr)a.buy_button.src=gbResources.getImage("add_to_cart"),a.buy_button.alt=h.gbResources.getString("csld-add_to_cart"),a.buy_button.style.opacity=1,a.buy_button.style.filter="alpha(opacity=100)",a.buy_button.style.cursor="pointer",b==GBDealNotifier.pendingAtcStr&&(d=a.getStatusContent(!0)),a.buy_button.onclick=function(b){b&&(b.stopPropagation(),b.preventDefault());
a.cx.buy(a.deal,a.selectedAsin.asin,!1);a.showBuying();a.updateSelectionBoxes();return!1};else{GBDealNotifier.DOM.replaceChildren(a.buyButtonContainer,[GBDealNotifier.DOM.img({id:"buying-"+a.deal.dealID,alt:h.gbResources.getString("csld-checking_deal_status"),style:"display: inline;",src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span({style:"color: #E68221;font-weight: bold;font-size: 10px;"},[h.gbResources.getString("csld-checking_deal_status_alt")])]);a.buy_button.onclick=null;return}else if(a.selectedAsin&&
100>a.selectedAsin.status.percentSoldOut&&100<=a.selectedAsin.status.percentClaimed){a.buy_button.src=gbResources.getImage("join_waitlist");a.buy_button.alt=h.gbResources.getString("join_waitlist");if(a.selectedAsin.status.currentlyUnavailable){Deal.DOM.replaceChildren(a.buyButtonContainer,[Deal.DOM.span({style:"position:relative; font-size: 11px; color:#900;"},[h.gbResources.getString("gbd_waitlist_full")])]);a.buy_button.onclick=null;return}a.buy_button.style.opacity=1;a.buy_button.style.filter=
"alpha(opacity=100)";a.buy_button.style.cursor="pointer";a.buy_button.onclick=function(b){b&&(b.stopPropagation(),b.preventDefault());a.cx.buy(a.deal,a.selectedAsin.asin,!0);a.showBuying();a.updateSelectionBoxes();return!1}}else a.buy_button.src=gbResources.getImage("add_to_cart"),a.buy_button.alt=h.gbResources.getString("csld-add_to_cart"),a.buy_button.onclick=null,a.buy_button.style.opacity=.5,a.buy_button.style.cursor="default",a.buy_button.style.filter="alpha(opacity=50)";GBDealNotifier.DOM.replaceChildren(a.buyButtonContainer,
[a.buy_button,c,d])},getStatusContent:function(a){var b=null;if(this.deal.pStatus==l||this.deal.pStatus[this.selectedAsin.asin]==l)this.deal.pStatus=[],this.deal.pStatus[this.selectedAsin.asin]=new GBDealNotifier.PStatus(this.deal);return b=this.deal.pStatus[this.selectedAsin.asin].getTimerMessage(this.selectedAsin.asin,null,a)},showBuying:function(){f(this.statusBoxObject).css("padding-left",50);GBDealNotifier.DOM.replaceChildren(this.buyButtonContainer,[GBDealNotifier.DOM.img({id:"buying-"+this.deal.dealID,
alt:h.gbResources.getString("csld-checking_deal_status"),style:"display: inline;",src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span({style:"color: #E68221;font-weight: bold;font-size: 10px;"},[h.gbResources.getString("csld-checking_deal_status_alt")])]);this.buy_button.onclick=null},statusBox:function(){this.statusBoxObject=GBDealNotifier.DOM.span({style:"padding-left: 10px; font-weight: bold; font-size: 13px; position: relative; top: -18px; left: 100px;"},GBDealNotifier.DOM.text(""));
this.updateStatusBox();return this.statusBoxObject},updateStatusBox:function(){var a="";this.selectedAsin!=l&&(GBDealNotifier.inState(null,this.selectedAsin,GBDealNotifier.claimedStr)?a=h.gbResources.getString("csld-claimed"):GBDealNotifier.inState(null,this.selectedAsin,GBDealNotifier.pendingAtcStr)||GBDealNotifier.inState(null,this.selectedAsin,GBDealNotifier.inCartStr)||GBDealNotifier.inState(null,this.selectedAsin,GBDealNotifier.waitInLineStr)||GBDealNotifier.inState(null,this.selectedAsin,GBDealNotifier.availableStr)||
GBDealNotifier.inState(null,this.selectedAsin,GBDealNotifier.expiredStr)||this.available||(a=h.gbResources.getString("csld-sold_out")));this.statusBoxObject.innerHTML=a},combine:function(a){for(var b=function(a,g,k,c){if(0==a)0<k.length&&(c[c.length]=k);else for(var d=0;d<g.length;d++)b(a-1,g.slice(d+1),k.concat([g[d]]),c)},c=[],d=0;d<a.length;d++)b(d,a,[],c);c.push(a);return c}});h.P&&h.P.AUI_BUILD_DATE&&(h.gbRegistered=h.gbRegistered||{},h.gbRegistered.gbDealNotifierScope||(h.gbRegistered.gbDealNotifierScope=
!0,t.register("gbDealNotifierScope",function(){return h.GBDealNotifier})))};if(h.P&&h.P.AUI_BUILD_DATE)t.when("A","dealResources").execute(function(f){w(f.$)});else if(h.amznJQ&&"object"===typeof amznJQ)amznJQ.onReady("jQuery",function(){w(h.jQuery)})}h.GBResources||function(){h.GBResources=new function(f,a){if(a===l)for(var b in a)f[b]=a[b];b=f&&f.__init__||function(){};b.prototype=f;return b}({__init__:function(f){this.strings={};this.images={};this.features={};this.customerData={};this.categories=
[];this.dealDebug=!1;this.loadedUrls={};this.amznMerchantID=this.preload_img_div=null;this.nodeIdToCategoryMap={};this.registered={};null!=f&&(f.strings&&this.registerStrings(f.strings),f.images&&this.registerImages(f.images),f.preloadImageList&&this.preloadImages(f.preloadImageList),f.features&&this.registerFeatures(f.features))},registerStrings:function(f){this.registerResources(this.strings,f)},getString:function(f,a){if(!(f in this.strings))return this.log('!!! ERROR: StringId "'+f+'" does not exist in the strings repository.'),
"";var b=""+this.strings[f];if(null==a)return b;for(var c in a)b=b.replace(new RegExp("\\${"+c+"}","g"),a[c]);return b},registerImages:function(f){this.registerResources(this.images,f)},preloadImages:function(f){if(null!==f&&f!==l)for(var a=0;a<f.length;++a)this.images[f[a]]&&this.preloadImage(this.images[f[a]])},preloadImage:function(f){this.preload_img_div||(this.preload_img_div=this.div({style:"display:none"}));this.preload_img_div.appendChild(this.img({src:f}))},getImage:function(f){return this.images[f]},
registerFeatures:function(f){this.registerResources(this.features,f)},getFeature:function(f){return this.features[f]},registerCustomerData:function(f){this.registerResources(this.customerData,f)},getCustomerData:function(f){return this.customerData[f]},registerCategories:function(f){this.registerResources(this.categories,f);this.registerNodeIdToCategoryMap()},getAllCategories:function(){return this.categories},registerNodeIdToCategoryMap:function(){for(var f=0;f<this.categories.length;f++){var a=
this.categories[f];this.nodeIdToCategoryMap[a.nodeId]=a.category}},getNodeIdToCategoryMap:function(){return this.nodeIdToCategoryMap},registerResources:function(f,a){if(null!==a&&null!==f)for(var b in a)f[b]=a[b]},setDealDebug:function(f){this.dealDebug=f},getDealDebug:function(){return this.dealDebug},registerFromJSON:function(f){f.GBStrings&&this.registerStrings(f.GBStrings);f.GBImages&&this.registerImages(f.GBImages);f.GBWeblabs&&this.registerFeatures(f.GBWeblabs);f.GBCustomerData&&this.registerCustomerData(f.GBCustomerData);
f.GBWidgetName&&this.registerFeatures(f.GBWidgetName);f.GBZone&&this.registerFeatures(f.GBZone);f.GBCategories&&this.registerCategories(f.GBCategories);f.GBDealDebug&&this.setDealDebug(f.GBDealDebug)},setAmznMerchantID:function(f){this.amznMerchantID=f},getAmznMerchantID:function(){return this.amznMerchantID},isAmznMerchant:function(f,a){if(f!==l&&null!==f){if(f==this.getAmznMerchantID())return!0}else if(a!==l&&null!==a&&(a=a.toLowerCase(),-1!=a.indexOf("amazon")))return!0;return!1},img:function(f){f=
f||{};f.border=f.border||0;return this.el("img",f)},div:function(f,a){return this.el("div",f,a)},el:function(f,a,b){f=document.createElement(f);a&&this.set_attributes(f,a);b&&this.appendChildren(f,b);return f},set_attributes:function(f,a){for(var b in a)"style"==b?f.style.cssText=a[b]:f[{"class":"className",checked:"defaultChecked",usemap:"useMap","for":"htmlFor",readonly:"readOnly",colspan:"colSpan",bgcolor:"bgColor",cellspacing:"cellSpacing",cellpadding:"cellPadding",valign:"vAlign",nowrap:"noWrap"}[b]||
b]=a[b]},log:function(f){f=new Date+": "+f;h.console&&h.console.log(f)},loadJS:function(f,a){if(f===l||null===f)this.log("GBResources::loadJS - Specified an undefined url");else if(this.loadedUrls[f])this.log("GBResources::loadJS - "+f+" is already loaded");else{this.loadedUrls[f]=!0;var b=document.createElement("script");b.type="text/javascript";b.src=f;b.async=a?!1:!0;document.getElementsByTagName("head")[0].appendChild(b)}},loadCSS:function(f){if(f===l||null===f)this.log("GBResources::loadCSS - Specified an undefined url");
else if(this.loadedUrls[f])this.log("GBResources::loadCSS - "+f+" is already loaded");else{this.loadedUrls[f]=!0;var a=document.createElement("link");a.type="text/css";a.rel="stylesheet";a.href=f;document.getElementsByTagName("head")[0].appendChild(a)}},getParamValueFromUrl:function(f,a){f=f.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=(new RegExp("[\\?&]"+f+"=([^&#]*)")).exec(a);return b?h.decodeURIComponent(b[1].replace(/\+/g," ")):""}})}();h.gbResources||(h.gbResources=new GBResources);h.P&&
h.P.AUI_BUILD_DATE?(h.gbRegistered=h.gbRegistered||{},h.gbResources.registered=h.gbResources.registered||{},h.gbRegistered.dealResources||h.gbResources.registered.dealResources||(h.gbRegistered.dealResources=!0,h.gbResources.registered.dealResources=!0,t.register("dealResources",function(){return h.GBResources}))):h.amznJQ&&"object"===typeof amznJQ&&amznJQ.declareAvailable("dealResources");var z=function(f,a,b){var c,d=GBDealNotifier.Class({__init__:function(a){this.displayingData=a.displayingData;
this.onClickFunction=a.onClickFunction;this.buyFunction=a.buyFunction;this.notifier=a.notifier;this.watchDealDisplayingData=a.watchDealDisplayingData;this.timers={};this.addToCartButtons={};this.refTagPrefix="xs_gb_ld_tck_";this.headerStrings={};this.setHeaderStrings();this.asinCategoryData={};for(var b in GBDealNotifier.stateAlertsEnum)this.asinCategoryData[GBDealNotifier.stateAlertsEnum[b]]=[];this.categorizeAsins();this.watchDealContentUtil=new e({watchDealDisplayingData:this.watchDealDisplayingData,
dealContentUtil:this})},setHeaderStrings:function(){this.headerStrings[GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON]={singular:gbResources.getString("dn-begin_checking_out_singular"),plural:gbResources.getString("dn-begin_checking_out_plural")};this.headerStrings[GBDealNotifier.stateAlertsEnum.ATC_EXPIRED]={singular:gbResources.getString("dn-time_ran_out_on_singular"),plural:gbResources.getString("dn-time_ran_out_on_plural")};this.headerStrings[GBDealNotifier.stateAlertsEnum.WL_PATC]={singular:gbResources.getString("dn-deal_is_avail_singular"),
plural:gbResources.getString("dn-deal_is_avail_plural")};this.headerStrings[GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED]={singular:gbResources.getString("dn-time_to_claim_ran_out_singular"),plural:gbResources.getString("dn-time_to_claim_ran_out_plural")};this.headerStrings[GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT]={singular:gbResources.getString("dn-deal_sold_out_singular"),plural:gbResources.getString("dn-deal_sold_out_plural")};this.headerStrings[GBDealNotifier.stateAlertsEnum.WL_DEAL_ENDED]=
{singular:gbResources.getString("dn-deal_has_ended_singular"),plural:gbResources.getString("dn-deal_has_ended_plural")};this.headerStrings[GBDealNotifier.watchDealStates.WD_LIVE]={singular:gbResources.getString("dn_watched_deal_starting_singular"),plural:gbResources.getString("dn_watched_deal_starting_plural")};this.headerStrings[GBDealNotifier.watchDealStates.WD_CANCELLED]={singular:gbResources.getString("dn_watched_deal_cancelled_singular"),plural:gbResources.getString("dn_watched_deal_cancelled_plural")}},
onClickA:function(a,b){var c=this,d=GBDealNotifier.DOM.a({href:"#"},b);f(d).click(function(){if(c.onClickFunction)c.onClickFunction();f(h.location).attr("href",a);return!1});return d},categorizeAsins:function(){for(var a in this.displayingData){var b=this.displayingData[a],c=b.deal,b=b.stateAlertEnum,d=GBDealNotifier.findDealAsin(a,c);null!=d&&(this.asinCategoryData[b]?this.asinCategoryData[b].push({dealAsin:d,deal:c}):this.log("Unrecognized stateAlertEnum found: "+b))}},getVariationString:function(a){var b=
"",c=[];if(a.variationData)for(var d in a.variationData)c.push(a.variationData[d]);0<c.length&&(b="("+c.join(", ")+")");return b},getUrl:function(a){return"/gp/product/"+a.asin+"/ref="+this.refTagPrefix+a.dealID},getViewMoreUrl:function(a,b){var c="",d="/ref=";a&&(c=a.dealID);var e="";"US"==gbResources.getCustomerData("realm")?e="/gp/goldbox/all-deals":(e=b.detail.buyBoxUrl,e.match(/\/$/)&&(d="ref="));var f="";-1!==e.indexOf("?")?(e=e.split("?"),f=e[0]+"/ref="+this.refTagPrefix+c+"?"+e[1]):f=e+d+
this.refTagPrefix+c;return f},getTimeLeftBlock:function(a,b){var c=a.status.purchaseStatus.expiresDate.getTime();this.timers[a.asin]=GBDealNotifier.CheckoutTimer(new Date(c),!0);c=[this.timers[a.asin].span,GBDealNotifier.DOM.span({"class":"a-size-small a-color-secondary",style:"display: block; line-height: 8px;"},[gbResources.getString("csld_remaining_part2")])];return GBDealNotifier.DOM.div({"class":"a-size-extra-large a-color-success",style:"text-align: right;"},c)},getHeader:function(a){a=[GBDealNotifier.DOM.span({"class":"a-box-inner a-padding-mini",
style:"padding-left:15px !important"},[GBDealNotifier.DOM.text(a)])];return GBDealNotifier.DOM.div({"class":"a-box a-spacing-micro a-spacing-top-micro a-box-tab a-color-alternate-background a-text-left",style:"border-radius:0px;border:0px;border-top:1px #dddddd solid;background:white !important;padding-top:8px;"},a)},getHeaderString:function(a,b,c){(a=this.headerStrings[a][1<c?"plural":"singular"])||(a=this.headerStrings[GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON]);return a},getAlertSprite:function(){return GBDealNotifier.DOM.div({style:"background-image: url("+
gbResources.getImage("alerts")+");background-repeat: no-repeat;background-position: -60px -188px;height: 30px;width: 30px;float: left;margin-right: 5px;"},[])},getViewCartButton:function(){var a=GBDealNotifier.DOM.span({"class":"a-button a-button-primary a-button-icon"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("i",{"class":"a-icon a-icon-cart"}),GBDealNotifier.DOM.el("input",{"class":"a-button-input",type:"submit"}),GBDealNotifier.DOM.span({"class":"a-button-text"},
[gbResources.getString("gbd_view_cart_proceed")])])]);return this.onClickA("/gp/cart/view.html/ref="+this.refTagPrefix+"atc",[a])},expiredMessage:function(a){var b=gbResources.getString("dn-see_current_price_avail"),c=gbResources.getString("dn-visit_detail_page");return GBDealNotifier.DOM.span({"class":"a-size-small"},[GBDealNotifier.DOM.text(b+" "),this.onClickA(this.getUrl(a),[GBDealNotifier.DOM.text(c)])])},getAtcButton:function(a,b,c){this.addToCartButtons[a.asin]=GBDealNotifier.DOM.div();b=null;
b=c?GBDealNotifier.DOM.span({"class":"a-button a-button-disabled",style:"width:95%"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{disabled:"disabled","class":"a-button-text"},[gbResources.getString("dn_add_to_cart_button_text")])])]):GBDealNotifier.DOM.span({"class":"a-button-normal a-button-primary a-button a-button-span12"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{"class":"a-button-text a-text-center"},[gbResources.getString("dn_add_to_cart_button_text")])])]);
this.setAtcOnClick(b,a.asin);GBDealNotifier.DOM.replaceChildren(this.addToCartButtons[a.asin],[b]);return this.addToCartButtons[a.asin]},setAtcOnClick:function(a,b,c){var d=this;a.onclick=function(a){a&&(a.stopPropagation(),a.preventDefault());d.notifier.buy(b,function(){d.setErrorAtcButton(b)},c);d.showProgress(b);return!1}},setErrorAtcButton:function(a){var b=gbResources.getString("dn-problem_atc"),c=gbResources.getString("dn-try_again"),c=GBDealNotifier.DOM.span({"class":"a-button a-button-beside-text a-button-primary a-button-small"},
[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.a({"class":"a-button-text"},[c])])]);this.setAtcOnClick(c,a);this.addToCartButtons[a]&&GBDealNotifier.DOM.replaceChildren(this.addToCartButtons[a],[GBDealNotifier.DOM.span({"class":"a-size-small a-color-error a-text-bold"},[b+" "]),c])},showProgress:function(a){this.addToCartButtons[a]&&GBDealNotifier.DOM.replaceChildren(this.addToCartButtons[a],[GBDealNotifier.DOM.img({alt:gbResources.getString("csld-checking_deal_status_alt"),
src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span({"class":"a-size-small a-color-state",style:"padding-left:5px;"},[gbResources.getString("csld-checking_deal_status")])])},getContent:function(a,b){return this.getDetailedViewAUIPopover(a,b)},getDetailedViewAUIPopover:function(a,b){var c=this,d,e;d=GBDealNotifier.DOM.div({style:"margin-bottom: 15px;"});var h=c.asinCategoryData[a],v=e=0;a===GBDealNotifier.watchStateAlertEnum.WATCH_DEAL?h=c.watchDealContentUtil.dealsCategoryData[a]:h.sort(c.sortByAsinTimes);
if(0===h.length)return d;for(var l=0;l<h.length;l++){var q=h[l],n=q.dealAsin,q=q.deal,r=null;switch(a){case GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON:r=c.getDetailedViewExpiresSoonDealTable(n,q);break;case GBDealNotifier.stateAlertsEnum.ATC_EXPIRED:r=c.getDetailedViewExpiredDealTable(n,q);break;case GBDealNotifier.stateAlertsEnum.WL_PATC:r=c.getDetailedViewWaitlistPendingATCDealTable(n,q);break;case GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED:r=c.getDetailedViewWaitListPendingATCExpiredDealTable(n,
q);break;case GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT:r=c.getDetailedViewWaitlistSoldOutDealTable(n,q);break;case GBDealNotifier.stateAlertsEnum.WL_DEAL_ENDED:r=c.getDetailedViewWaitlistDealEndedDealTable(n,q);break;case GBDealNotifier.watchStateAlertEnum.WATCH_DEAL:q.status.isValidDeal?(r=c.getWatchDealLiveDealTable(q),e++):(r=c.getWatchDealCancelledDealTable(q),v++)}l!=h.length-1&&(r.style.borderBottom="1px solid rgb(228, 228, 228)");null!==r&&(d.appendChild(r),f.each(f(r).find(".ellipsifyTitle"),
function(a,b){c.watchDealContentUtil.ellipsify({el:f(b),jQuery:f})}))}a===GBDealNotifier.watchStateAlertEnum.WATCH_DEAL?e?v?(h=1<e?gbResources.getString("dn_deal_starting_plural"):gbResources.getString("dn_deal_starting_singular"),l=1<v?gbResources.getString("dn_deal_cancelled_plural"):gbResources.getString("dn_deal_cancelled_singular"),e=gbResources.getString("dn_watched_deal_tagline")+e+h+gbResources.getString("dn_and_string")+v+l):e=c.getHeaderString(GBDealNotifier.watchDealStates.WD_LIVE,b,e):
e=c.getHeaderString(GBDealNotifier.watchDealStates.WD_CANCELLED,b,v):e=c.getHeaderString(a,b,h.length);return{content:d,header:e}},getAlertContent:function(){for(var a=[GBDealNotifier.stateAlertsEnum.WL_PATC,GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON,GBDealNotifier.stateAlertsEnum.ATC_EXPIRED,GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED,GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT,GBDealNotifier.stateAlertsEnum.WL_DEAL_ENDED,GBDealNotifier.watchStateAlertEnum.WATCH_DEAL],b=[],c=[],d=0;d<a.length;d++){var e=
this.getContent(a[d]);e.content&&(b.push(e.content),c.push(e.header))}return{contentArray:b,headersArray:c}},sortByAsinTimes:function(a,b){return a.dealAsin.status.purchaseStatus.expiresDate-b.dealAsin.status.purchaseStatus.expiresDate},getDetailedViewImageUrl:function(a){a=a.imageURL;a=GBDealNotifier.Utilities.checkAndSetSSLImageUrl(a);return a=GBDealNotifier.resizeImage(a,100)},getDetailedViewTimeLeftBlock:function(a,b,c,d){b=a.status.purchaseStatus.expiresDate.getTime();this.timers[a.asin]=GBDealNotifier.CheckoutTimer(new Date(b),
!0);a=d?"00:00":this.timers[a.asin].span;c?c=[GBDealNotifier.DOM.span({"class":"a-size-small a-color-base"},[gbResources.getString("dn_timer_span_part_1")]),GBDealNotifier.DOM.span({"class":"a-size-small a-text-bold"},[a]),GBDealNotifier.DOM.span({"class":"a-size-small a-color-base"},[gbResources.getString("dn_claim_the_deal_string")])]:(c=d?gbResources.getString("dn_timer_span_part_2")+gbResources.getString("dn_timer_span_expired_part"):gbResources.getString("dn_timer_span_part_2"),c=[GBDealNotifier.DOM.span({"class":"a-size-small a-color-base"},
[gbResources.getString("dn_timer_span_part_1")]),GBDealNotifier.DOM.span({"class":"a-size-small a-text-bold"},[a]),GBDealNotifier.DOM.span({"class":"a-size-small a-color-base"},[c])]);return GBDealNotifier.DOM.div({"class":"a-spacing-top-mini"},c)},getDetailedView_ViewCartButton:function(){var a=GBDealNotifier.DOM.span({"class":"a-button-normal a-button-primary a-button a-button-span12"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{"class":"a-button-text a-text-center"},
[gbResources.getString("dn_view_cart_button_text")])])]);return this.onClickA("/gp/cart/view.html/ref="+this.refTagPrefix+"atc",[a])},getDetailedViewExpiredMessageBlock:function(a){var b=GBDealNotifier.DOM.span({},[gbResources.getString("dn-see_current_price_avail")]),c=gbResources.getString("dn-visit_detail_page");a=this.onClickA(this.getUrl(a),[GBDealNotifier.DOM.text(c)]);return GBDealNotifier.DOM.div({"class":"a-size-small",style:"padding:25px 9px 35px 9px"},[b,GBDealNotifier.DOM.el("br",{},[]),
a])},getDetailedViewExpiresSoonDealTable:function(a,b){return this.getDetailedViewDealTable(a,b)},getDetailedViewExpiredDealTable:function(a,b){return GBDealNotifier.DOM.table({width:"97%",cellpadding:0,cellspacing:0,style:"margin: 10px 4px;width:97% !important;",dealID:b.dealID},[GBDealNotifier.DOM.tr({style:"vertical-align: top;"},[GBDealNotifier.DOM.td({style:"vertical-align: top;width:25%","class":"firstColumnDiv"},[this.watchDealContentUtil.getImage(this.getDetailedViewImageUrl(a),this.getUrl(a))]),
GBDealNotifier.DOM.td({style:"width:75%","class":"middleColumnDiv"},[this.getDetailedViewExpiredMessageBlock(a)])])])},getDetailedViewWaitlistPendingATCDealTable:function(a,b){return this.getDetailedViewDealTable(a,b,!0)},getDetailedViewWaitListPendingATCExpiredDealTable:function(a,b){return this.getDetailedViewDealTable(a,b,!0,!0)},getDetailedViewWaitlistSoldOutDealTable:function(a,b){var c=GBDealNotifier.DOM.span({},[gbResources.getString("dn_waitlisted_deal_sold_out_msg")]),d=this.watchDealContentUtil.getTitleBlock(b.detail.title,
this.getUrl(a)),c=GBDealNotifier.DOM.div({style:"padding:25px 9px 35px 9px;"},[c,d]);return this.getDetailedViewWaitlistCasesDealTable(a,b,c)},getDetailedViewWaitlistDealEndedDealTable:function(a,b){var c=GBDealNotifier.DOM.span({},[gbResources.getString("dn_waitlisted_deal_ended_msg")]),d=this.watchDealContentUtil.getTitleBlock(b.detail.title,this.getUrl(a)),c=GBDealNotifier.DOM.div({style:"padding:25px 9px 35px 9px;"},[c,d]);return this.getDetailedViewWaitlistCasesDealTable(a,b,c)},getDetailedViewWaitlistCasesDealTable:function(a,
b,c){return GBDealNotifier.DOM.table({width:"97%",cellpadding:0,cellspacing:0,style:"margin: 10px 4px;width:97% !important;",dealID:b.dealID},[GBDealNotifier.DOM.tr({style:"vertical-align: top;"},[GBDealNotifier.DOM.td({style:"vertical-align: top;width:25%","class":"firstColumnDiv"},[this.watchDealContentUtil.getImage(this.getDetailedViewImageUrl(a),this.getUrl(a))]),GBDealNotifier.DOM.td({style:"width:75%;","class":"middleColumnDiv"},[c])])])},getDetailedViewDealTable:function(a,b,c,d){var e=null,
e=c?GBDealNotifier.DOM.td({style:"padding:5px"},[this.getAtcButton(a,b,d),this.getDetailedViewTimeLeftBlock(a,b,!0,d)]):GBDealNotifier.DOM.td({style:"padding:5px"},[this.getDetailedView_ViewCartButton(b),this.getDetailedViewTimeLeftBlock(a,b,!1,d)]);return GBDealNotifier.DOM.table({width:"97%",cellpadding:0,cellspacing:0,style:"margin: 10px 4px;width:97% !important;",dealID:b.dealID},[GBDealNotifier.DOM.tr({style:"vertical-align: top;"},[GBDealNotifier.DOM.td({style:"vertical-align: top;width:25%",
"class":"firstColumnDiv"},[this.watchDealContentUtil.getImage(this.getDetailedViewImageUrl(a),this.getUrl(a))]),GBDealNotifier.DOM.td({style:"width:43%","class":"middleColumnDiv"},[this.getMainTileDetailsBlock(b,a)]),GBDealNotifier.DOM.td({style:"width:32%;padding-right:5px;","class":"lastColumnDiv"},[e])])])},getMainTileDetailsBlock:function(a,b){return GBDealNotifier.DOM.div({style:"width:95%;margin-right:-300px;float:left;","class":"a-spacing-base a-fixed-right-grid-col fixedPaddingLeft a-col-right"},
[this.watchDealContentUtil.getPriceBlock(a.pricingData.dealPrice),this.watchDealContentUtil.getDiscountBlock(a.pricingData.basisPrice,a.pricingData.percentOff),this.watchDealContentUtil.getTitleBlock(a.detail.title,this.getUrl(b)),a.merchantName?this.watchDealContentUtil.getSoldbyBlock(a.merchantName):"",a.reviews?this.watchDealContentUtil.getReviewStarsBlock(a.reviews.URL,a.reviews.total,a.reviews.rating):""])},getWatchDealLiveDealTable:function(a){return this.watchDealContentUtil.getDealTableWatchDealLive(a)},
getWatchDealCancelledDealTable:function(a){return this.watchDealContentUtil.getDealTableWatchDealCancelled(a)}});h.DealNotifier=GBDealNotifier.Class({__init__:function(b){var k=this;k.dealExpirationConnections={};k.dealExpiresSoonConnections={};if(null==h.navbar||null==h.navbar.getLightningDealsData||"function"!=typeof h.navbar.getLightningDealsData)k.log("Error: navbar is not defined, cannot continue!");else if(k.lightningDealsData=h.navbar.getLightningDealsData(),k.asinDates={},k.cartAsins=k.getCartAsins(),
k.waitlistAsins={},k.warningThresholdOffset=b.thresholdOffset,k.remindersWeblab=b.remindersWeblab,k.dealRedemptionServiceWeblab=b.dealRedemptionServiceWeblab,k.sessionId=b.sessionId,k.now=parseInt(b.now,10),k.popupSkin=b.popupSkin,k.debug=b.debug||!1,k.waitlistedAsins=b.waitlistedAsins,k.watchedDeals=b.watchedDeals,k.hasEverWatchedDeal=b.hasEverWatchedDeal,c=a,k.alertPopover=null,k.alertPopoverAnchor=null,k.alertPopoverContainer=null,k.seenInfo={},k.onHideData=[],k.displayingData={},k.warningThresholdOffset||
(k.warningThresholdOffset="C"),k.active=!1,k.deals={},k.asins={},k.currentAsinStates={},k.watchWaitlistedDeals={},k.displayedExpired={},k.displayedExpiresSoon={},k.displayedPendingATC={},k.displayedPendingATCExpired={},k.displayedWaitListSoldOut={},k.getDealsResponseCache={},k.asinStatesEnum={INITIALIZE:0,CHECK_SEEN:1,CALL_REGISTER_DEAL:2,DISPLAY:3},k.asinStatePriority={},k.asinStatePriority[GBDealNotifier.inCartStr]=6,k.asinStatePriority[GBDealNotifier.pendingAtcStr]=4,k.asinStatePriority[GBDealNotifier.waitInLineStr]=
3,k.asinStatePriority[GBDealNotifier.expiredStr]=2,k.asinStatePriority[GBDealNotifier.availableStr]=1,k.asinStatePriority[GBDealNotifier.claimedStr]=0,k.stateStrings={},k.stateStrings[GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON]="expires_soon",k.stateStrings[GBDealNotifier.stateAlertsEnum.ATC_EXPIRED]="expired",k.stateStrings[GBDealNotifier.stateAlertsEnum.WL_PATC]="wl_patc",k.stateStrings[GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED]="wl_patc_expired",k.stateStrings[GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT]=
"wl_sold_out",k.stateStrings[GBDealNotifier.stateAlertsEnum.WL_DEAL_ENDED]="wl_deal_ended",GBDealNotifier.Service.base_retry_interval=3E4,GBDealNotifier.Service.continue_requests=!0,k.service=new GBDealNotifier.Service({marketplace_id:k.getMarketplaceId()||1,customer_id:k.getCustomerId(),session_id:k.getSessionId(),timeout:6E5,includeVariations:!0}),k.buying={},k.waitlistIntervalTimer=3E4,k.waitlistInterval=null,k.getCustomerId()){var d=[],e;for(e in k.cartAsins)d.push(k.cartAsins[e].ASIN);d=d.concat(k.waitlistedAsins);
k.isDeal(d,function(a){if(a){var b=[],g;for(g in d){var c=a.dealItems[d[g]];c&&c.length&&b.push({dealID:c[0],itemIDs:[d[g]]})}k.getDeals(b,function(a){a&&(k.getDealsResponseCache=k._prepareDealsInfo(a),k.hasLightningDeals()&&k.registerAsinTimeouts(),k.registerWaitListDeals(),k.log("DealNotifier instantiated."))},function(a){k.log("error calling getDeal in init method of DealNotifier "+a)})}},function(a){k.log("error calling isDeal in init method of DealNotifier "+a)});k.watchDealNotifier=new h.WatchDealNotifier({dealNotifier:k});
"T2"===k.remindersWeblab&&k.hasEverWatchedDeal&&k.watchDealNotifier.registerWatchDeals(k.watchedDeals)}else k.log("Customer is not recognized, shutting down.")},registerWaitListDeals:function(){for(var a=this.waitlistedAsins,b=!1,c=0;c<a.length;c++)this.waitlistAsins[a[c]]={},b=!0;b&&this.getDealsForWaitlistAsins.apply(this)},getDealsForWaitlistAsins:function(){var a=[],b;for(b in this.waitlistAsins)a.push(b);if(0===a.length)this.log("No WaitListed ASINs, not calling GetDeals.");else{b={};var c=this.getDealsResponseCache.deals;
if(null==c)this.log("No Deals found in SelectDeals response.  Returning.");else{for(var d=0;d<c.length;d++){var a=c[d],e=new GBDealNotifier.Model.Deal(a.dealID);e.legacyDealID=a.legacyDealID;e.load_from_deal(a);a=e.asins;if(null==a)this.log("Asins list for Deal ("+e.dealID+") is null - skipping.");else for(var h=0;h<a.length;h++){var f=a[h];if(this.waitlistAsins[f.asin])if(null==f.status||null==f.status.purchaseStatus||null==f.status.purchaseStatus.state)this.log("Empty PurchaseStatus or State, skipping: "+
f.asin),this.stopWatchingWaitlistAsin(f.asin);else{var l=f.status.purchaseStatus.state,q=GBDealNotifier.pStateTypeMap[l];q!=GBDealNotifier.pStateTypeEnum.WAITLIST&&q!=GBDealNotifier.pStateTypeEnum.EITHER?(this.log("DealAsin isn't in a WaitList state, skipping: "+f.asin+"; pState: "+l+"; type: "+q),this.stopWatchingWaitlistAsin(f.asin)):(b[f.asin]=1,l=new Date(f.status.purchaseStatus.expiresDate),l=new Date(l.getFullYear(),l.getMonth(),l.getDate()),l=Math.floor(l.getTime()/1E3),this.waitlistAsins[f.asin]=
{dealId:e.dealID,lastUpdated:l},this.asinDates[f.asin]=l,this.cartAsins[f.asin]={ASIN:f.asin,discountExpirationDate:l},this.registerDeal.apply(this,[f.asin,e]))}}}for(var n in this.waitlistAsins)b[n]||(this.log("GetDeals didn't return an ASIN we requested, removing it from our watch list: "+n),this.stopWatchingWaitlistAsin(n));this._pollStatusForWaitlistedAsins()}}},registerWaitlistDeal:function(a,b){this.log("Registering waitlist deal: "+a);this.watchWaitlistedDeals[a]&&(this.log("Already watching ASIN: "+
a+"; replacing with new one."),delete this.watchWaitlistedDeals[a]);this.watchWaitlistedDeals[a]=b;this.examineWaitListDeal(a,b);this._pollStatusForWaitlistedAsins()},examineWaitListDeal:function(a,b){var c=this;if(null==b||null==a)c.log("Deal or ASIN is null, returning.");else{var d=GBDealNotifier.findDealAsin(a,b);null==d?c.log("No DealAsin found, returning."):c.getNotificationInfo(a,c.cartAsins[a].discountExpirationDate,function(e){var f=null,h=d.status.purchaseStatus.state;c.registerSeenInfo(a,
e.seen);if(h===GBDealNotifier.pendingAtcStr)f=GBDealNotifier.stateAlertsEnum.WL_PATC,0>=d.status.purchaseStatus.msToExpiry&&(f=GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED);else if(h===GBDealNotifier.expiredStr)f=GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED;else if(h===GBDealNotifier.waitInLineStr)if(100<=parseInt(d.status.percentSoldOut,10)||parseInt(d.status.offerServiceSoldOut))f=GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT;else return;else{c.stopWatchingWaitlistAsin(a);return}e=c.getStateString(f);
1==c.seenInfo[a][e]?c.log("Customer has already seen an alert for: "+a+"; state: "+e+". Not showing alert."):(h===GBDealNotifier.pendingAtcStr&&b.connect("pstatus_expire",function(a,b){c.handleStateExpiration(a,b,GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED);c.stopWatchingWaitlistAsin(b)}),c.displayAlert(a,f))},function(a){c.log("Error getting Wait List info: "+a)})}},refreshWatchedDealView:function(a,b){self.watchDealContentUtil.refreshWatchedDealView(a,b)},_pollStatusForWaitlistedAsins:function(){var a=
this;a.getCustomerId()?a.getSessionId()?(a.waitlistInterval||(a.waitlistInterval=h.setInterval(function(){a.updateWaitlistDeals.apply(a)},a.waitlistIntervalTimer)),a.log("DealNotifier activated.")):a.log("DealNotifier cannot activate without a SessionID."):a.log("DealNotifier cannot activate without a CustomerID.")},_stopPollingForWaitlistedAsins:function(){this.waitlistInterval&&(this.waitlistInterval=h.clearInterval(this.waitlistInterval));this.log("DealNotifier deactivated.")},updateWaitlistDeals:function(){var a=
this;a.log("Checking for Deals to Update");0===a._getDealIdsFromWaitlistAsins().length?(a.log("No more Wait Listed ASINs, shutting down."),a._stopPollingForWaitlistedAsins()):a.getDealAsinStatuses(function(b){b=b.dealAsinStatuses;for(var c=0;c<b.length;c++){var d=b[c],e=d.dealID,f=d.asin;null!=a.waitlistAsins[f]&&a.waitlistAsins[f].dealId==e?(a.watchWaitlistedDeals[f].load_from_asin_status(d),a.examineWaitListDeal(f,a.watchWaitlistedDeals[f])):a.log("Not a Waitlist ASIN: "+f)}},function(b){a.log("GetDealAsinStatus: FAILURE: "+
b)})},registerAsinTimeouts:function(){for(var a in this.cartAsins){var b=parseInt(this.cartAsins[a].discountExpirationDate,10);this.registerAsin(a,b)}},registerAsin:function(a,b){var c=this;c.currentAsinStates[a]=c.asinStatesEnum.INITIALIZE;var d=c.getDealAsinStatusObj(a),e=null;d&&d.purchaseStatus&&(d=d.purchaseStatus.msToExpiry,e=new Date,e=(e.getTime()-e.getMilliseconds())/1E3,e=Math.floor(d/1E3+e));d=c.getTimeUntilWarn(e,c.now);c.log("TimeLapse: "+d);0<d?(h.setTimeout(function(){c.nextFunction(a).apply(c,
[a])},1E3*d),c.log("ASIN Registered: "+a)):c.log("ASIN Registration cancelled as it is already expired: "+a)},nextFunction:function(a){var b={};b[this.asinStatesEnum.INITIALIZE]=this.asinStatesEnum.CHECK_SEEN;b[this.asinStatesEnum.CHECK_SEEN]=this.asinStatesEnum.CALL_REGISTER_DEAL;b[this.asinStatesEnum.CALL_REGISTER_DEAL]=this.asinStatesEnum.DISPLAY;b[this.asinStatesEnum.DISPLAY]=null;this.currentAsinStates[a]=b[this.currentAsinStates[a]];b=null;switch(this.currentAsinStates[a]){case this.asinStatesEnum.INITIALIZE:b=
function(){};break;case this.asinStatesEnum.CHECK_SEEN:b=this.checkIfSeen;break;case this.asinStatesEnum.CALL_REGISTER_DEAL:b=this.callRegisterDeal;break;case this.asinStatesEnum.DISPLAY:b=this.displayAlert;break;default:b=function(){}}return b},checkIfSeen:function(a){var b=this;b.log("Checking if Customer has seen Alert for ASIN: "+a);b.getNotificationInfo(a,b.cartAsins[a].discountExpirationDate,function(c){1!=c.seen.expired&&(b.registerSeenInfo(a,c.seen),b.nextFunction(a).call(b,a))},function(a){b.log("Error getting asin state info: "+
a)})},callRegisterDeal:function(a){var b=this.getDealsResponseCache.deals;if(null==b)this.log("No Deals found in SelectDeals response.  Returning.");else for(var c=0;c<b.length;c++){var d=b[c],e=new GBDealNotifier.Model.Deal(d.dealID);e.legacyDealID=d.legacyDealID;e.purchaseStatusWarningThreshold=this.getWarningThreshold();e.load_from_deal(d);if(null==e.asins)break;for(var f=0;f<e.asins.length;f++){var h=e.asins[f];if(h.asin!=a)this.log("ASINs don't match for DealID: "+d.dealID+": "+h.asin+" != "+
a+"(original) (SKIPPING)");else{if("InCart"===h.status.purchaseStatus.state||"Expired"===h.status.purchaseStatus.state){this.registerDeal(a,e);return}this.log("Deal status is not 'InCart': "+h.status.purchaseStatus.state)}}}},displayAlert:function(a,b){var c=this,d=c.watchWaitlistedDeals[a];c.getDealStatus([{dealID:d.dealID,itemIDs:[a]}],function(e){e.dealAsinStatuses[0].purchaseStatus.state!==GBDealNotifier.claimedStr&&(null==d?c.log("ERROR, displayAlert was called for an ASIN with no Deal! ASIN: "+
a):(1!=c.getDisplayed(a,b)?(c.addOnHideData(a,b),c.createOrAddAlert(a,d,b)):c.log("Already displayed Alert for: "+d.dealID+"; "+a),c.setDisplayed(a,b)))},function(a){c.log("getDealStatus: FAILURE: "+a)})},insertDisplayingData:function(a,b,c){null==a||null==b||null==c?this.log("Error inserting DisplayingData, asin, deal, or stateAlertEnum is null."):this.displayingData[a]={deal:b,stateAlertEnum:c}},getDisplayingData:function(){return this.displayingData},getDisplayed:function(a,b){var c=!1;switch(b){case GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON:c=
1==this.displayedExpiresSoon[a];break;case GBDealNotifier.stateAlertsEnum.ATC_EXPIRED:c=1==this.displayedExpired[a];break;case GBDealNotifier.stateAlertsEnum.WL_PATC:c=1==this.displayedPendingATC[a];break;case GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED:c=1==this.displayedPendingATCExpired[a];break;case GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT:c=1==this.displayedWaitListSoldOut[a]}return c},setDisplayed:function(a,b){switch(b){case GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON:this.displayedExpiresSoon[a]=
1;break;case GBDealNotifier.stateAlertsEnum.ATC_EXPIRED:this.displayedExpired[a]=1;break;case GBDealNotifier.stateAlertsEnum.WL_PATC:this.displayedPendingATC[a]=1;break;case GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED:this.displayedPendingATCExpired[a]=1;break;case GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT:this.displayedWaitListSoldOut[a]=1}},createOrAddAlert:function(a,b,c){this.log("Called createOrAddAlert for: "+a+"; "+b.dealID);this.insertDisplayingData(a,b,c);this.createGenericAlert()},createGenericAlert:function(){var c=
this,d=c.getPopupContent(),e=d.content,d=d.header;c.alertPopover&&(b.remove(c.alertPopover),c.alertPopover=null);c.alertPopoverAnchor||(c.alertPopoverAnchor=GBDealNotifier.DOM.div({id:"gb_deal_notifier_anchor",style:"position:fixed;top:10px;right:50px;height:1px;width:1px;"}),f("body").append(c.alertPopoverAnchor));var p=f("#gb_deal_notifier_anchor");c.alertPopover=b.create(p,{content:e,header:d,position:"triggerBottom",activate:"onclick",width:500,name:"DealNotifierPopover"});f(c.alertPopover.inlineContent).css({maxHeight:f(h).height()-
100});a.on("a:popover:dismiss:DealNotifierPopover",function(){c.alertPopover&&c.handleOnHide.apply(c,[])});a.on("a:popover:show:DealNotifierPopover",function(b){var c=parseInt(b.popover.$popover.css("z-index"));a.isFiniteNumber(c)&&210>=c&&b.popover.$popover.css("z-index",c+210);b.popover.$popover.find(".a-arrow-border").hide()});c.alertPopover.lock();p.trigger("click");c.alertPopover&&(f(h).resize(function(){c.handleWindowResize()}),f(h).scroll(function(){c.handleWindowResize()}))},handleWindowResize:function(){this.alertPopover&&
(c?this.alertPopover.updatePosition():(this.alertPopover.css("left",f(h).scrollLeft()+f(h).width()-this.alertPopover.outerWidth()-10),f.browser.msie?this.alertPopover.css("top",f(h).scrollTop()+10):this.alertPopover.css("top",10)))},handleOnHide:function(a,b){if(!b)for(var c=0;c<this.onHideData.length;c++){var d=this.onHideData[c],e=d.asin,f=d.discountExpirationDate,d=d.stateAlertEnum;a!=l&&e!=a||this.setNotificationInfo.apply(this,[e,f,d])}if("T2"===this.remindersWeblab&&this.watchDealNotifier){c=
"";if(a||b)a&&b&&(c=a+",");else{for(var h in this.watchDealNotifier.watchDealDisplayingData)c+=h+",";this.watchDealNotifier.callModifyWatchedDeals("clearValue")}c&&(c=c.substr(0,c.length-1),this.watchDealNotifier.updateWatchedDealSeenInfo({action:"setSeen",dealIDs:c}));this.watchDealNotifier.watchDealDisplayingData={};this.watchDealNotifier.updateWatchedDeals={}}this.alertPopover.hide();this.onHideData=[];this.displayingData={};this.alertPopoverAnchor=this.alertPopoverContainer=this.alertPopover=
null},getPopupContent:function(){for(var a=this,b=new d({displayingData:a.displayingData,notifier:a,onClickFunction:function(b){a.handleOnHide.apply(a,[b])},watchDealDisplayingData:a.watchDealNotifier?a.watchDealNotifier.watchDealDisplayingData:null}),c=b.getAlertContent(),e=c.contentArray,c=c.headersArray,h=gbResources.getString("dn-deal-notifications"),x=GBDealNotifier.DOM.div({"class":"lightningDealAlertBox",width:"100%",style:"margin:-18px;"}),l=0;l<e.length;l++){var y=e[l];f(y).prepend(b.getHeader(c[l]));
x.appendChild(y)}return{content:x,header:h}},registerCartDeal:function(a,b){var c=this;b.purchaseStatusWarningThreshold=c.getWarningThreshold();c.seenInfo[a]&&c.seenInfo[a].expired||(c.dealExpirationConnections[a]=b.connect("pstatus_expire",function(a,b){c.handleStateExpiration(a,b,GBDealNotifier.stateAlertsEnum.ATC_EXPIRED)}));c.seenInfo[a]&&c.seenInfo[a].expires_soon||(c.dealExpiresSoonConnections[a]=b.connect("pstatus_expires_soon",function(a,b){c.handleStateExpiration(a,b,GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON)}))},
registerDeal:function(a,b){if(this.getCustomerId())if(this.getSessionId()||this.log("Error: Cannot register a deal if the customer has no SessionID."),null==a||null==b)this.log("Error: registerDeal(): Must provide both an asin and a Deal object.");else{var c=GBDealNotifier.findDealAsin(a,b);if(null==c)this.log("Error: couldn't find corresponding DealAsin for Deal: "+b.dealID+"; ASIN: "+a);else{b.pricingData=b.pricingData||{};var d=c.dealPrice,e=c.basisPrice;if(null!==d&&null!==e)if(b.pricingData.dealPrice=
d instanceof Object?GBDealNotifier.Utilities.getFormattedPrice(d.price,d.currency):d,b.pricingData.basisPrice=e instanceof Object?GBDealNotifier.Utilities.getFormattedPrice(e.price,e.currency):e,b.pricingData.percentOff=c.percentOff,null==c.status)this.log("Error: DealAsinStatus is null for Deal: "+b.dealID+"; ASIN: "+a);else if(d=c.status.purchaseStatus.state)if(d===GBDealNotifier.availableStr||d===GBDealNotifier.claimedStr)this.log("Purchase state is Available or Claimed.  Ignoring.");else{e=null;
if(this.watchWaitlistedDeals[a]){e=GBDealNotifier.findDealAsin(a,this.watchWaitlistedDeals[a]).status.purchaseStatus.state;e=this.asinStatePriority[e];d=this.asinStatePriority[d];if(null==e||null==d){this.log("Error: Priorities for deal are null.");return}if(e>=d){this.log("Incoming DealAsinPurchaseState has a lower priority than the current one, ignoring: Deal: "+b.dealID+"; ASIN: "+a);return}this.waitlistAsins[a]?this.stopWatchingWaitlistAsin(a):this.stopWatchingCartAsin(a);delete this.watchWaitlistedDeals[a]}e=
this.getRegisterFunction(c);null!=e&&(this.setDealAndDateData(a,b),e.apply(this,[a,b]));this.log("Registered DealID "+b.dealID+" for: ASIN "+a)}else this.log("Error: PurchaseState is null for Deal: "+b.dealID+"; ASIN: "+a)}}else this.log("Error: Cannot register a deal if the customer is not recognized.")},disconnectAll:function(){for(var a in this.dealExpirationConnections)this.dealExpirationConnections[a].disconnect();for(a in this.dealExpirationConnections)this.dealExpiresSoonConnections[a].disconnect();
this.dealExpirationConnections={};this.dealExpiresSoonConnections={}},handleStateExpiration:function(a,b,c){var d=GBDealNotifier.findDealAsin(b,a),e=this;e.watchWaitlistedDeals[d.asin]?(e.log("handleStateExpire ("+d.asin+"): Watching ASIN - CONTINUE."),a=e.getSeenAlertForState(d.asin,c),b=e.getDisplayed(d.asin,c),1==a||1==b?e.log("Already seen alert for ("+d.asin+", "+c+") - ignoring"):(e.log("Haven't seen alert, continuing"),e.getNotificationInfo(d.asin,e.cartAsins[d.asin].discountExpirationDate,
function(a){e.registerSeenInfo(d.asin,a.seen);0==e.getSeenAlertForState(d.asin,c)&&e.getStatusAndDisplayAlert(d.asin,c)},function(a){e.seenInfo[d.asin]={expires_soon:!1,expired:!1};e.displayAlert(d.asin,c)}))):e.log("handleStateExpire ("+d.asin+"): Not watching ASIN - IGNORING.")},getStatusAndDisplayAlert:function(a,b){var c=this;c.getDealAsinStatus(a,function(d){d=d.dealAsinStatuses;if(null==d||0==d.length)c.log("Error, dealAsinStatuses is null or empty. Not displaying alert.");else{for(var e=null,
f=0;f<d.length;f++){var h=d[f];if(null!=h&&h.asin==a){e=h;break}}null==e?c.log("Couldn't find DealAsinStatus for "+a+"; not displaying alert."):c.displayAlert(a,b)}},function(a){c.log("Error calling GetDealAsinStatus: "+a)})},getSeenAlertForState:function(a,b){if(!this.seenInfo[a])return this.log("no info, returning null"),null;var c=this.stateStrings[b];if(null==c)return!1;c=this.seenInfo[a][c];return null==c?!1:c},getDealAsinStatus:function(a,b,c){if(null==a)this.log("Asin is null, can't call GetDealAsinStatus.");
else{var d=this.watchWaitlistedDeals[a];d&&d.dealID?this.getDealStatus([{dealID:d.dealID,itemIDs:[a]}],b,c):this.selectDeals([a],b,c)}},getDealAsinStatuses:function(a,b){var c=[],d;for(d in this.waitlistAsins)this.waitlistAsins[d]&&this.waitlistAsins[d].dealId&&c.push({dealID:this.waitlistAsins[d].dealId,itemIDs:[d]});this.log("Calling GetDealAsinStatuses: "+c);this.getDealStatus(c,a,b)},_getDealIdsFromWaitlistAsins:function(){var a=[],b;for(b in this.waitlistAsins)this.waitlistAsins[b]&&this.waitlistAsins[b].dealId&&
a.push(this.waitlistAsins[b].dealId);return a},getTimeUntilWarn:function(a,b){var c=a-b-this.getWarningThreshold()/1E3;0>c&&(c=0);return c},hasLightningDeals:function(){var a=this.getCartAsins(),b;for(b in a)if(null!=b)return!0;return!1},isDeal:function(a,b,c){a&&0!==a.length?this.service.call("/xa/dealcontent/v2/IsDeal",{requestMetadata:{marketplaceID:this.getMarketplaceId(),clientID:"goldbox_notifier"},itemIDs:a,dealTypes:["LIGHTNING_DEAL"],dealStates:["AVAILABLE","WAITLIST","WAITLISTFULL","EXPIRED",
"SOLDOUT"]},function(a){b(a)},function(a){c(a)}):this.log("no asins specified while calling isDeal for DealNotifer. returning")},getDeals:function(a,b,c){a&&0!==a.length?this.service.call("/xa/dealcontent/v2/GetDeals",{requestMetadata:{marketplaceID:this.getMarketplaceId(),customerID:this.getCustomerId(),sessionID:this.getSessionId(),clientID:"goldbox_notifier"},dealTargets:a},function(a){b(a)},function(a){c(a)}):this.log("no deal target is specified while calling GetDeals in DealNotifier. returning")},
getDealStatus:function(a,b,c){var d=this;a&&0!==a.length?d.service.call("/xa/dealcontent/v2/GetDealStatus",{requestMetadata:{marketplaceID:d.getMarketplaceId(),customerID:d.getCustomerId(),sessionID:d.getSessionId(),clientID:"goldbox_notifier"},responseSize:"STATUS_ONLY",itemResponseSize:"NONE",page:1,dealsPerPage:a.length,dealTargets:a,queryProfile:{dealTypes:["LIGHTNING_DEAL"]}},function(a){a=d.prepareDealAsinStatuses(a);b(a)},function(a){c(a)}):d.log("no deal target is specified while calling GetDealStatus in DealNotifier. returning")},
prepareDealAsinStatuses:function(a){if(a){var b=[];a=a.dealStatus;for(var c in a){var d=a[c].dealItemStatus;if(d)for(var e in d){var f=d[e];f&&(f=this._itemStatusToAsinStatus(f,e,c),b.push(f))}}return{dealAsinStatuses:b}}},_prepareDealsInfo:function(a){var b=[],c=[],d=a.dealStatus;a=a.dealDetails;for(var e in a){var f=a[e],h=[],l={customer:{}},q=a[e].items;if(q)for(i=0;i<q.length;i++){var n=q[i],r={status:{}};r.asin=n.itemID;r.dealID=e;r.imageURL=n.primaryImage;r.dealPrice=GBDealNotifier.Utilities.getFormattedPrice(n.dealPrice,
n.currencyCode);r.basisPrice=GBDealNotifier.Utilities.getFormattedPrice(n.bAmount,n.currencyCode);r.percentOff=n.percentOff?GBDealNotifier.Utilities.getDisplayablePercentOff(n.percentOff):"";if(n.variationDimensions){r.variationData={};for(var t in n.variationDimensions)r.variationData[t]=n.variationDimensions[t]}if(d[e]&&d[e].dealItemStatus&&d[e].dealItemStatus[n.itemID]){var w=d[n.dealID].dealItemStatus[n.itemID];r.isCustomerClaimed=GBDealNotifier.customerStates[w.customerState]==GBDealNotifier.claimedStr?
!0:!1;n=this._itemStatusToAsinStatus(w,n.itemID,e);r.status=n;c.push(n)}h.push(r)}l.asins=h;l.dealID=e;l.legacyDealID=f.legacyDealID;l.marketplaceID=gbResources.getCustomerData("realm");l.detail={title:f.title,buyBoxUrl:f.ingressUrl};l.merchantName=f.merchantName;l.reviews={};GBDealNotifier.Utilities._loadReviewsFromServiceResponse(l,f);b.push(l)}return{deals:b,dealAsinStatuses:c}},_itemStatusToAsinStatus:function(a,b,c){var d={};a&&(d.purchaseStatus={},d.purchaseStatus.waitListStatus={},d.asin=b,
d.dealID=c,d.percentClaimed=a.percentClaimed,"SOLDOUT"===a.itemState&&(d.percentSoldOut=100,d.offerServiceSoldOut=!0),d.currentlyUnavailable="WAITLISTFULL"===a.itemState?!0:!1,d.purchaseStatus.lastUpdated=a.lastUpdated,d.purchaseStatus.msToExpiry=a.msToCustomerStateExpiry,d.purchaseStatus.msToCacheExpires=a.msCacheTtl,d.purchaseStatus.state=GBDealNotifier.customerStates[a.customerState],a.waitlistPosition&&(d.purchaseStatus.waitListStatus.position=a.waitlistPosition,d.purchaseStatus.waitListStatus.inCartIndicator=
a.waitlistChance));return d},getWarningThreshold:function(){var a=12E4;"C"!=this.warningThresholdOffset&&(a=6E4*parseInt(this.warningThresholdOffset,10));return a},getCartAsins:function(){var a=this.lightningDealsData.activeItems,b={};if(null==a||a==l)return b;for(var c=0;c<a.length;c++){var d=a[c];b[d.ASIN]=d;this.asinDates[d.ASIN]=d.discountExpirationDate}return b},addOnHideData:function(a,b){var c=this.cartAsins[a];null==c||null==c.discountExpirationDate?this.log("Error adding onHideData: no cart data for ASIN: "+
a):this.onHideData.push({asin:a,stateAlertEnum:b,discountExpirationDate:c.discountExpirationDate})},getCustomerId:function(){return this.lightningDealsData.customerID},getSessionId:function(){return this.sessionId},getMarketplaceId:function(){return this.lightningDealsData.marketplaceID},getNoCacheValue:function(){return(new Date).getTime()},getNotificationInfo:function(a,b,c,d){a={success:function(a){c(a)},error:function(a){d(a)},failure:function(a){d(a)},url:"/gp/deal/ajax/getSeen.html?customerID="+
this.getCustomerId()+"&sessionID="+this.getSessionId()+"&asin="+a+"&dealExpirationDate="+b+"&nocache="+this.getNoCacheValue(),type:"POST",data:"{}",dataType:"json"};f.ajax(a)},setNotificationInfo:function(a,b,c){var d=this,e=null;d.stateStrings[c]?(e=d.stateStrings[c],e=d.stateStrings[c],d.log("Setting notification info for: ("+a+", "+b+", "+c+" ("+e+"))"),a={success:function(a){a.success?d.log("Successfully setSeen for asin: "+a.request.asin+"; "+a.request.ded):d.log("Error calling setSeen for asin: "+
a.request.asin+"; "+a.request.ded)},error:function(a){d.log("Error calling setSeen: "+a)},failure:function(a){d.log("Failure calling setSeen: "+a)},url:"/gp/deal/ajax/setSeen.html?customerID="+d.getCustomerId()+"&sessionID="+d.getSessionId()+"&asin="+a+"&dealExpirationDate="+b+"&state="+e+"&nocache="+d.getNoCacheValue(),type:"POST",data:"{}",dataType:"json"},f.ajax(a)):d.log("Invalid eStateAlert: '"+c+"' - cannot set notification info.")},buy:function(a,b,c){if(this.service.customer_id){var d,e;c?
(d=this.watchDealNotifier.updateWatchedDeals[a],e=d.detail.buyAsin):(d=this.watchWaitlistedDeals[a],e=a);if(null==d)this.log("Error: Can't call buy, no Deal found for ASIN: "+e);else{var f=d.dealID;this.buying[f]||(this.buying[f]=!0,"T1"===this.dealRedemptionServiceWeblab?this.buyCallingDRS(d,e,a,c,b):this.buyCallingDealService(d,e,a,c,b))}}else this.log("Error: Can't call buy if the customer is unrecognized!")},buyCallingDRS:function(a,b,c,d,e){var f=this;f.isWatchedDeal=d;f.asinOrDealId=c;f.service.claim_deal(a.dealID,
b,function(c){var d=GBDealNotifier.responseCustomerStates.NONE;c!==l&&null!==c&&(c=c.dealItemStatus,c!==l&&null!==c&&(d=c.customerState));d===GBDealNotifier.responseCustomerStates.INCART?(f.isWatchedDeal?f.handleOnHide(f.asinOrDealId,f.isWatchedDeal):f.handleOnHide(b),h.location="/gp/cart/view.html/ref=xs_gb_ld_tck_"+a.dealID):d===GBDealNotifier.responseCustomerStates.INWAITLIST?f.handleOnHide(f.asinOrDealId,f.isWatchedDeal):e();delete f.isWatchedDeal;delete f.asinOrDealId},function(a){f.log("Error calling ClaimDeal: "+
a);e()})},buyCallingDealService:function(a,b,c,d,e){var f=this;f.isWatchedDeal=d;f.asinOrDealId=c;f.service.redeem_deal(a.legacyDealID,b,function(c){if(1==c.redeemed){c=c.deal.asins;for(var d,m=0;m<c.length&&(d=c[m],d.asin!=b);m++);d&&d.status.purchaseStatus.state===GBDealNotifier.inCartStr?(f.isWatchedDeal?f.handleOnHide(f.asinOrDealId,f.isWatchedDeal):f.handleOnHide(d),h.location="/gp/cart/view.html/ref=xs_gb_ld_tck_"+a.dealID):d&&d.status.purchaseStatus.state===GBDealNotifier.waitInLineStr?f.handleOnHide(f.asinOrDealId,
f.isWatchedDeal):e();delete f.isWatchedDeal;delete f.asinOrDealId}else e()},function(a){f.log("Error caling RedeemDeal: "+a);e()})},calculatePurchaseStateEpoch:function(a,b){var c=0,d=GBDealNotifier.findDealAsin(b,a);d.status&&d.status.purchaseStatus&&(c=d.status.purchaseStatus.msToExpiry,d=new Date,d=(d.getTime()-d.getMilliseconds())/1E3,c=Math.floor(c/1E3+d),c=new Date(1E3*c),c=new Date(c.getFullYear(),c.getMonth(),c.getDate()),c=Math.floor(c.getTime()/1E3),this.log("Setting purchaseStateEpoch to: "+
c));return c},registerSeenInfo:function(a,b){this.seenInfo[a]={};for(var c in b)this.seenInfo[a][c]=b[c]},setDealAndDateData:function(a,b){this.watchWaitlistedDeals[a]=b;var c=GBDealNotifier.findDealAsin(a,b),c=this.getPurchaseStateType(c);this.cartAsins[a]&&c!=GBDealNotifier.pStateTypeEnum.WAITLIST||(this.log("Deal was sent from a widget, overriding CartData: "+b.dealID+"; "+a),c=this.calculatePurchaseStateEpoch(b,a),this.setDateData(a,b,c))},setDateData:function(a,b,c){this.cartAsins[a]={ASIN:a,
discountExpirationDate:c};this.asinDates[a]=c;c=GBDealNotifier.findDealAsin(a,b);this.getPurchaseStateType(c)==GBDealNotifier.pStateTypeEnum.WAITLIST&&(c=c.status.purchaseStatus.lastUpdated,this.log("Adding Asin to WaitList watch list: "+a),this.waitlistAsins[a]={dealId:b.dealID,lastUpdated:c})},getPurchaseStateType:function(a){var b=null;a&&a.status&&a.status.purchaseStatus&&(b=GBDealNotifier.pStateTypeMap[a.status.purchaseStatus.state]);return b},getRegisterFunction:function(a){var b=null;switch(GBDealNotifier.pStateTypeMap[a.status.purchaseStatus.state]){case GBDealNotifier.pStateTypeEnum.CART:this.log("Cart Deal: "+
a.asin);b=this.registerCartDeal;break;case GBDealNotifier.pStateTypeEnum.WAITLIST:this.log("WaitList Deal: "+a.asin);b=this.registerWaitlistDeal;break;case GBDealNotifier.pStateTypeEnum.EITHER:this.log("Cart Deal: "+a.asin);b=this.registerCartDeal;break;default:this.log("Invalid State for DealAsin"+a.asin)}return b},stopWatchingWaitlistAsin:function(a){this.log("Removing Wait List ASIN from watch list: "+a);delete this.waitlistAsins[a]},stopWatchingCartAsin:function(a){this.log("Removing Cart ASIN from watch list: "+
a);this.dealExpirationConnections[a]&&(this.dealExpirationConnections[a].disconnect(),delete this.dealExpirationConnections[a]);this.dealExpiresSoonConnections[a]&&(this.dealExpiresSoonConnections[a].disconnect(),delete this.dealExpiresSoonConnections[a])},getStateString:function(a){return this.stateStrings[a]},log:function(a){this.debug&&GBDealNotifier.log(a)},getDealAsinStatusObj:function(a){if(this.getDealsResponseCache){var b=this.getDealsResponseCache.dealAsinStatuses;if(b.length)for(var c=0;c<
b.length;c++)if(b[c].asin===a)return b[c]}return null}});var e=GBDealNotifier.Class({__init__:function(a){this.watchDealDisplayingData=a.watchDealDisplayingData;this.dealContentUtil=a.dealContentUtil;this.dealsCategoryData={};for(var b in GBDealNotifier.watchStateAlertEnum)this.dealsCategoryData[GBDealNotifier.watchStateAlertEnum[b]]=[];this.watchDealDisplayingData&&this.categorizeDeals()},categorizeDeals:function(){for(var a in this.watchDealDisplayingData){var b=this.watchDealDisplayingData[a],
c=b.deal,b=b.watchDealState;this.dealsCategoryData[b]&&this.dealsCategoryData[b].push({deal:c})}},getDealTableWatchDealCancelled:function(a){return GBDealNotifier.DOM.table({width:"97%",cellpadding:0,cellspacing:0,style:"margin: 10px 4px;width:97% !important;",dealID:a.dealID},[GBDealNotifier.DOM.tr({style:"vertical-align: top;"},[GBDealNotifier.DOM.td({style:"vertical-align: top;width:25%","class":"firstColumnDiv"},[this.getImage(a.detail.imageAsin,a.detail.URL)]),GBDealNotifier.DOM.td({style:"width:75%",
"class":"middleColumnDiv"},[this.getCancelledTitleBlock(a.detail.title,a.detail.URL)])])])},getCancelledTitleBlock:function(a,b){var c=GBDealNotifier.DOM.span({},[gbResources.getString("dn_watched_deal_cancelled_msg")]),d=this.getTitleBlock(a,b);return GBDealNotifier.DOM.div({style:"padding:25px 9px 35px 9px;"},[c,d])},getDealTableWatchDealLive:function(a,b){var c=null,d="a-color-base";switch(a.status.dealState){case GBDealNotifier.dealStates.AVAILABLE:c=this.getAtcButton(a);break;case a.status.dealState===
GBDealNotifier.dealStates.SOLDOUT:c=GBDealNotifier.DOM.td({style:"padding-top:2px"},[this.getSoldOutBlock(a)]);d="a-color-tertiary";break;case GBDealNotifier.dealStates.EXPIRED:c=GBDealNotifier.DOM.td({style:"padding-top:2px"},[this.getExpiredBlock(a)]);d="a-color-tertiary";break;case GBDealNotifier.dealStates.WAITLIST:c=this.getJoinWaitlistButton(a);break;case GBDealNotifier.dealStates.WAITLISTFULL:c=GBDealNotifier.DOM.td({style:"padding-top:2px"},[this.getWaitListFullBlock(a)]),d="a-color-tertiary"}"VARIATION_ITEM"===
a.detail.itemType&&(c=this.getSeeDetailsButton(a));b&&f(".lightningDealAlertBox").find("table[dealID = "+a.dealID+" ]").remove();return GBDealNotifier.DOM.table({width:"97%",cellpadding:0,cellspacing:0,style:"margin: 10px 4px;width:97% !important;",dealID:a.dealID},[GBDealNotifier.DOM.tr({style:"vertical-align: top;"},[GBDealNotifier.DOM.td({style:"vertical-align: top;width:25%","class":"firstColumnDiv"},[this.getImage(a.detail.imageAsin,a.detail.URL)]),GBDealNotifier.DOM.td({style:"width:43%","class":"middleColumnDiv"},
[this.getMainTileDetailsBlock(a,d)]),GBDealNotifier.DOM.td({style:"width:32%;padding: 0px 12px;","class":"lastColumnDiv"},[c])])])},refreshWatchedDealView:function(a,b){self.getDealTableWatchDealLive(a,b)},getMainTileDetailsBlock:function(a,b){b||(b="a-color-base");var c=a.pricingData.prices.basisPrice?a.pricingData.prices.basisPrice.min.formattedValue:"";return GBDealNotifier.DOM.div({style:"width:95%;margin-right:-300px;float:left;","class":"a-spacing-base a-fixed-right-grid-col fixedPaddingLeft a-col-right"},
[this.getPriceBlock(a.pricingData.prices.dealPrice?a.pricingData.prices.dealPrice.min.formattedValue:"",b),this.getDiscountBlock(c,a.pricingData.percentOff,b),this.getClaimedProgressBarBlock(a.status.percentClaimed,b),this.getClaimedTextBlock(a.status.percentClaimed,a.status.msToEnd,b),this.getTitleBlock(a.detail.title,a.detail.URL,b),this.getSoldbyBlock(a.merchantName,b),this.getReviewStarsBlock(a.reviews.URL,a.reviews.total,a.reviews.rating)])},getPriceBlock:function(a,b){b||(b="a-color-base");
return GBDealNotifier.DOM.div({"class":"a-row unitLineHeight a-spacing-mini "+b},[GBDealNotifier.DOM.span({"class":"a-color-small heading4 inlineBlock unitLineHeight",style:""},[a])])},getDiscountBlock:function(a,b,c){c||(c="a-color-base");return"CN"===gbResources.getCustomerData("realm")?"":GBDealNotifier.DOM.div({"class":"a-row unitLineHeight a-spacing-mini "+c},[GBDealNotifier.DOM.span({"class":"a-size-mini inlineBlock unitLineHeight"},["List: "]),GBDealNotifier.DOM.span({"class":"a-size-mini inlineBlock unitLineHeight a-text-strike"},
[a]),GBDealNotifier.DOM.span({"class":"a-size-mini inlineBlock unitLineHeight"},[" ("+b+"% Off)"])])},getClaimedProgressBarBlock:function(a,b){b||(b="a-color-base");return GBDealNotifier.DOM.div({"class":"a-row"},[GBDealNotifier.DOM.div({"class":"a-row progbarWrapper",style:"position:relative;height:4px;background-color:#DDDDDD;font-size:1px;"},[GBDealNotifier.DOM.div({"class":"progbar",style:"width:"+a+"%;height:4px;position:absolute;background-color:"+("a-color-tertiary"===b?"grey":"#E77600")+";font-size:1px;"})])])},
getClaimedTextBlock:function(a,b){var c=new Date;c.setMilliseconds(c.getMilliseconds()+b);return GBDealNotifier.DOM.div({"class":"a-row unitLineHeight"},[GBDealNotifier.DOM.div({"class":"a-column a-span6"},[GBDealNotifier.DOM.span({"class":"a-size-mini a-color-secondary inlineBlock unitLineHeight percentClaimedSpan"},[a+"% claimed"])]),GBDealNotifier.DOM.div({"class":"a-column a-span6 a-text-right unitLineHeight a-span-last"},[GBDealNotifier.DOM.div({"class":"a-row"},[GBDealNotifier.DOM.span({"class":"a-size-mini a-color-secondary inlineBlock unitLineHeight"},
["Ends in"]),GBDealNotifier.DOM.span({"class":"a-size-mini a-color-secondary inlineBlock unitLineHeight"},[" "]),GBDealNotifier.DOM.span({"class":"a-size-mini a-color-secondary inlineBlock unitLineHeight"},[GBDealNotifier.Timer(c).span])])])])},getTitleBlock:function(a,b,c){c||(c="a-color-base");a="a-color-tertiary"===c?GBDealNotifier.DOM.a({style:"max-height:34px;overflow:hidden;width:auto;color:#0066c0 !important","class":"a-size-base a-link-normal titleLineHeight ellipsifyTitle "+c},[a]):GBDealNotifier.DOM.a({href:b,
style:"max-height:34px;overflow:hidden;width:auto;color:#0066c0 !important","class":"a-size-base a-link-normal titleLineHeight ellipsifyTitle "+c},[a]);return GBDealNotifier.DOM.div({"class":"a-row unitLineHeight a-spacing-top-mini a-spacing-mini "+c,style:"max-height:34px;overflow:hidden;color:#0066c0"},[GBDealNotifier.DOM.div({"class":"a-row  inlineBlock unitLineHeight"},[a])])},getSoldbyBlock:function(a,b){b||(b="a-color-base");return GBDealNotifier.DOM.div({"class":"a-row a-spacing-mini "},[GBDealNotifier.DOM.div({"class":"a-row unitLineHeight"},
[GBDealNotifier.DOM.span({"class":"a-size-mini a-color-base inlineBlock unitLineHeight"+b},[gbResources.getString("dn_sold_by_string")+a])])])},getReviewStarsBlock:function(a,b,c){var d=Math.floor(c);c-=d;c=.7<c?++d:.3<=c?d+"-5":d;return GBDealNotifier.DOM.div({"class":"a-row unitLineHeight"},[GBDealNotifier.DOM.div({"class":"a-row reviewStars"},[GBDealNotifier.DOM.a({href:a,"class":"a-link-normal touchAnchor"},[GBDealNotifier.DOM.el("i",{"class":"a-icon a-icon-star a-star-"+c}),b])])])},getImage:function(a,
b){var c;c=GBDealNotifier.resizeImage(a,100);c=GBDealNotifier.DOM.img({src:c,border:0});c=this.onClickA(b,c);return GBDealNotifier.DOM.div({style:"width:85%;height:85%;vertical-align:middle;text-align:center;padding:5%;"},[c])},getAtcButton:function(a,b){var c=null,c=b?GBDealNotifier.DOM.span({"class":"a-button a-button-disabled"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{disabled:"disabled","class":"a-button-text"},[gbResources.getString("dn_add_to_cart_button_text")])])]):
GBDealNotifier.DOM.span({"class":"a-button-normal a-button-primary a-button a-button-span12"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{"class":"a-button-text a-text-center"},[gbResources.getString("dn_add_to_cart_button_text")])])]);this.dealContentUtil.setAtcOnClick(c,a.dealID,!0);return c},getJoinWaitlistButton:function(a){var b=GBDealNotifier.DOM.span({"class":"a-button-normal a-button-primary a-button a-button-span12"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},
[GBDealNotifier.DOM.el("button",{"class":"a-button-text a-text-center"},[gbResources.getString("dn_join_waitlist_button_text")])])]);this.dealContentUtil.setAtcOnClick(b,a.dealID,!0);return b},getSeeDetailsButton:function(a){var b=GBDealNotifier.DOM.span({"class":"a-button-normal a-button-primary a-button a-button-span12"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{"class":"a-button-text a-text-center"},[gbResources.getString("dn_see_details_button_text")])])]);
return this.onClickA(a.detail.egressUrl,[b])},getWaitListFullBlock:function(a){return GBDealNotifier.DOM.span({},[gbResources.getString("dn_waitlist_full_string")])},getSoldOutBlock:function(a){return GBDealNotifier.DOM.span({},[gbResources.getString("dn_sold_out_string")])},getExpiredBlock:function(a){return GBDealNotifier.DOM.span({},[gbResources.getString("dn_expired_string")])},onClickA:function(a,b){var c=this,d=GBDealNotifier.DOM.a({href:a},[b]);f(d).click(function(){if(c.onClickFunction)c.onClickFunction();
f(h.location).attr("href",a);return!1});return d},ellipsify:function(a){var b=a.el,c=a.jQuery,d=a.wordsIntact;a=a.removeDots;var e=b.clone().empty().css({display:"none",height:"auto"}).width(b.width());b.width(b.width());c(b).after(e);var f=c.trim(b.html());e.html(f);if(!(e.height()<=b.height())){e.empty();for(var h=0,l=0,q=f.length;h<f.length&&l<q;)h=Math.floor((l+q)/2),a?e.html(f.substr(0,h)):e.html(f.substr(0,h)+"..."),e.height()<=b.height()?l=h+1:q=h-1;f=f.substr(0,l-1);d&&(d=f.lastIndexOf(" "),
f=f.substr(0,d));a||(f+="...");b.html(f)}c(e).remove()}});h.WatchDealNotifier=GBDealNotifier.Class({__init__:function(a){this.dealNotifier=a.dealNotifier;this.allWatchedDeals={};this.dealsSeenInfo={};this.updateWatchedDeals={};this.displayedWatched={};this.watchDealDisplayingData={};this.watchDealsIntervalTimer=1E4;this.watchDealsInterval=null},_activatePollingWatched:function(){var a=this;a.dealNotifier.getCustomerId()?a.dealNotifier.getSessionId()?(a.watchDealsInterval||(a.watchDealsInterval=h.setInterval(function(){a.callModifyWatchedDeals.apply(a,
["getValue"])},a.watchDealsIntervalTimer)),a.dealNotifier.log("WatchDealNotifier activated")):a.dealNotifier.log("WatchDealNotifier cannot activate without a SessionID"):a.dealNotifier.log("WatchDealNotifier cannot activate without a CustomerID")},_deactivatePollingWatched:function(){this.watchDealsInterval&&(this.watchDealsInterval=h.clearInterval(this.watchDealsInterval));this.dealNotifier.log("WatchDealNotifier deactivated")},registerWatchDeals:function(a){a=this._makeDealIdsString(a);this._registerFilteredWatchedDeals(a)},
_makeDealIdsString:function(a){for(var b="",c=a.length,d=0;d<c;d++){var e=a[d];this.allWatchedDeals[e]||(b+=e+",")}return b=""===b?"":b.substr(0,b.length-1)},_registerFilteredWatchedDeals:function(a){var b=this;a&&b.updateWatchedDealSeenInfo({action:"getSeen",dealIDs:a},function(a){var c=a.value;a=[];for(var d in c){var e=parseInt(c[d]);(b.dealsSeenInfo[d]=e)||a.push({dealID:d})}d=GBDealNotifier.GD_BATCH_SIZE;for(var c=(c=a.length%d)?c:d,e=Math.ceil(a.length/d),f=0;f<e;f++){var g;g=d*f;g=f===e-1?
a.slice(g,g+c):a.slice(g,g+d);b.dealNotifier.getDeals(g,function(a){b._registerWatchDealObjects(a)},function(a){b.dealNotifier.log("getDeal Status call fails "+a)})}},function(a){});b.watchDealsInterval||b._activatePollingWatched()},updateWatchedDealSeenInfo:function(a,b,c){f.post("/gp/deal/ajax/modifyDealSeenInfo.html",{action:a.action,dealIDs:a.dealIDs},function(a){b&&b(a)},"json")},_registerWatchDealObjects:function(a){for(var b in a.dealDetails){var c=a.dealStatus[b],d=a.dealDetails[b],e=c.dealState;
if(e===GBDealNotifier.dealStates.EXPIRED||e===GBDealNotifier.dealStates.SOLDOUT||e===GBDealNotifier.dealStates.WAITLISTFULL)this.allWatchedDeals[b]=e;else if(e!==GBDealNotifier.dealStates.UPCOMING&&e!==GBDealNotifier.dealStates.COMINGSOON||!c.isValid){var e=c.dealItemStatus&&c.dealItemStatus[d.reviewAsin],f;e&&(f=e.customerState);!f||f!==GBDealNotifier.responseCustomerStates.INCART&&f!==GBDealNotifier.responseCustomerStates.CLAIMED&&f!==GBDealNotifier.responseCustomerStates.PENDINGATC&&f!==GBDealNotifier.responseCustomerStates.INWAITLIST&&
f!==GBDealNotifier.responseCustomerStates.EXPIRED?(e=new GBDealNotifier.Model.WatchDeal(b),e._loadDetailsFromServiceResponse(d),e._loadStatusFromServiceResponse(c),e._updateTeaserDetails(d),e.customerData.marketplaceID=this.dealNotifier.getMarketplaceId(),e.customerData.customerID=this.dealNotifier.getCustomerId(),e.customerData.dealID=b,this._renderWatchedDeal(e),e.status.isValidDeal?(this.updateWatchedDeals[b]=e,this.allWatchedDeals[b]="live"):this.allWatchedDeals[b]="cancelled"):this.allWatchedDeals[b]=
f}}},_renderWatchedDeal:function(a){this._ifDealDisplayed(a.dealID)||(this._insertDealDisplayingData(a),this.dealNotifier.createGenericAlert());this._setDealDisplayed(a.dealID)},_insertDealDisplayingData:function(a){this.watchDealDisplayingData[a.dealID]={deal:a,watchDealState:GBDealNotifier.watchStateAlertEnum.WATCH_DEAL}},_ifDealDisplayed:function(a){var b=!1;return b=this.displayedWatched[a]},_setDealDisplayed:function(a){this.displayedWatched[a]=!0},_refreshWatchedDealNotifier:function(a,b){this.dealNotifier.refreshWatchedDealView(a,
b)},callModifyWatchedDeals:function(a){var b=this;f.post("/gp/goldbox/ajax/getWatchedDeals.html",{action:a},function(a){b._updateWatchedDeals(a)})},_updateWatchedDeals:function(a){var b=this;b.dealNotifier.log("Checking for watched deals to update");(a=b._makeDealIdsString(a.value))&&b._registerFilteredWatchedDeals(a);a=[];for(var c in b.updateWatchedDeals)a.push({dealID:c});b.dealNotifier.getDealStatus(a,function(a){a=a.dealStatus;for(var c in a){var d=a[c].dealState,e=a[c].percentClaimed,f=b.updateWatchedDeals[c].status.percentClaimed;
if(d!=b.updateWatchedDeals[c].status.dealState||e!=f)b.updateWatchedDeals[c].status.dealState=d,b.updateWatchedDeals[c].status.percentClaimed=e,b._refreshWatchedDealNotifier(b.updateWatchedDeals[c],!0);else break}},function(a){})}});h.P&&h.P.AUI_BUILD_DATE&&(h.gbRegistered=h.gbRegistered||{},h.gbRegistered.lightningDealNotifier||(h.gbRegistered.lightningDealNotifier=!0,t.register("lightningDealNotifier",function(){return h.DealNotifier})))};h.P&&h.P.AUI_BUILD_DATE&&t.when("A","a-popover","gbDealNotifierScope").execute(function(f,
a){z(f.$,f,a)})})})(function(){var t=window.AmazonUIPageJS||window.P,h=t._namespace||t.attributeErrors;return h?h("GoldboxDealNotifierAssets"):t}(),window);